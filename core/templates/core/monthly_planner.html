{% extends 'base.html' %}
{% load custom_filters %}

{% block title %}Monthly Planner - Liesbeek Master Plan{% endblock %}

{% block extra_css %}
<style>
    .month-cell {
        min-height: 120px;
        transition: all 0.2s ease;
    }
    .month-cell:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .task-badge {
        transition: all 0.15s ease;
    }
    .task-badge:hover {
        transform: scale(1.05);
    }
    .overflow-indicator {
        cursor: pointer;
        transition: all 0.15s ease;
    }
    .overflow-indicator:hover {
        background-color: rgba(22, 101, 52, 0.1);
    }
</style>
{% endblock %}

{% block content %}
<!-- Floating Action Button (Mobile) -->
<button class="fab md:hidden bg-primary text-white z-40 open-modal-btn" aria-label="New Task">
    <span class="material-symbols-outlined text-2xl">add</span>
</button>

<header class="px-4 py-3 border-b border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-900 md:px-8 md:h-16 flex flex-col md:flex-row md:items-center justify-between shrink-0 gap-3">
    <div class="flex items-center justify-between md:justify-start gap-4">
        <div>
            <h1 class="text-lg font-semibold dark:text-white md:text-xl">Monthly Planner</h1>
            <span class="text-[10px] text-slate-500 md:text-xs md:bg-slate-100 md:dark:bg-slate-800 md:px-3 md:py-1 md:rounded-full md:font-medium">
                {{ month_name }} {{ year }}
                {% if is_current_month %}<span class="text-primary ml-1">â€¢ Current</span>{% endif %}
            </span>
        </div>
        <a href="{% url 'daily_agenda' %}" class="md:hidden flex items-center gap-1 px-3 py-1.5 bg-primary text-white rounded-lg text-xs font-bold">
            <span class="material-symbols-outlined text-sm">view_agenda</span>
            Today
        </a>
    </div>
    <div class="flex items-center gap-2 md:gap-3">
        <!-- View Toggle -->
        <div class="flex border border-slate-200 dark:border-slate-700 rounded-lg overflow-hidden">
            <a href="{% url 'weekly_planner' %}" class="px-3 py-1.5 md:px-4 bg-white dark:bg-slate-800 hover:bg-slate-50 dark:hover:bg-slate-700 text-slate-600 dark:text-slate-300 text-xs md:text-sm font-medium border-r border-slate-200 dark:border-slate-700 transition-colors">
                Week
            </a>
            <span class="px-3 py-1.5 md:px-4 bg-primary text-white text-xs md:text-sm font-medium">
                Month
            </span>
        </div>

        <!-- Month Navigation -->
        <div class="flex border border-slate-200 dark:border-slate-700 rounded-lg overflow-hidden">
            <a href="{% url 'monthly_planner' %}?year={{ prev_year }}&month={{ prev_month }}" class="px-2 py-1.5 md:px-3 bg-white dark:bg-slate-800 hover:bg-slate-50 dark:hover:bg-slate-700 text-slate-600 dark:text-slate-300 border-r border-slate-200 dark:border-slate-700 transition-colors">
                <span class="material-symbols-outlined text-base align-middle leading-none">chevron_left</span>
            </a>
            <a href="{% url 'monthly_planner' %}" class="hidden md:block px-4 py-1.5 bg-white dark:bg-slate-800 hover:bg-slate-50 dark:hover:bg-slate-700 text-slate-600 dark:text-slate-300 text-sm font-medium border-r border-slate-200 dark:border-slate-700 transition-colors">
                Current
            </a>
            <a href="{% url 'monthly_planner' %}?year={{ next_year }}&month={{ next_month }}" class="px-2 py-1.5 md:px-3 bg-white dark:bg-slate-800 hover:bg-slate-50 dark:hover:bg-slate-700 text-slate-600 dark:text-slate-300 transition-colors">
                <span class="material-symbols-outlined text-base align-middle leading-none">chevron_right</span>
            </a>
        </div>

        <button class="hidden md:flex items-center gap-2 bg-primary text-white px-5 py-2 rounded-xl text-sm font-bold shadow-sm hover:bg-forest hover:shadow-md transition-all active:scale-95 open-modal-btn">
            <span class="material-symbols-outlined text-lg">add_circle</span>
            New Task
        </button>
    </div>
</header>

<div class="flex-1 overflow-auto p-4 md:p-8 custom-scrollbar">
    <div class="min-w-[1000px] md:min-w-0">
        <!-- Day Headers -->
        <div class="grid grid-cols-7 gap-2 mb-3">
            <div class="text-center py-2"><span class="text-sm font-semibold text-slate-400 uppercase tracking-wider">Mon</span></div>
            <div class="text-center py-2"><span class="text-sm font-semibold text-slate-400 uppercase tracking-wider">Tue</span></div>
            <div class="text-center py-2"><span class="text-sm font-semibold text-slate-400 uppercase tracking-wider">Wed</span></div>
            <div class="text-center py-2"><span class="text-sm font-semibold text-slate-400 uppercase tracking-wider">Thu</span></div>
            <div class="text-center py-2"><span class="text-sm font-semibold text-slate-400 uppercase tracking-wider">Fri</span></div>
            <div class="text-center py-2"><span class="text-sm font-semibold text-slate-400 uppercase tracking-wider">Sat</span></div>
            <div class="text-center py-2"><span class="text-sm font-semibold text-slate-400 uppercase tracking-wider">Sun</span></div>
        </div>

        <!-- Calendar Grid -->
        <div class="space-y-2">
            {% for week in month_weeks %}
            <div class="grid grid-cols-7 gap-2">
                {% for day in week %}
                    {% with day_tasks=tasks_by_date|get_item:day %}
                    {% with team_tasks=day_tasks|filter_by_assignee:"team" %}
                    {% with manager_tasks=day_tasks|filter_by_assignee:"manager" %}
                    <div class="month-cell group relative bg-white dark:bg-slate-800 rounded-xl border {% if day.month == month %}border-slate-200 dark:border-slate-700{% else %}border-slate-100 dark:border-slate-800 bg-slate-50/50 dark:bg-slate-900/30{% endif %} overflow-hidden cursor-pointer"
                         data-date="{{ day|date:'Y-m-d' }}"
                         data-has-tasks="{% if day_tasks %}true{% else %}false{% endif %}">

                        <!-- Day Number -->
                        <div class="flex items-center justify-between px-3 py-2 border-b border-slate-100 dark:border-slate-700/50 {% if day == today %}bg-primary/5{% endif %}">
                            <span class="text-sm font-semibold {% if day.month == month %}text-slate-700 dark:text-slate-200{% else %}text-slate-400{% endif %} {% if day == today %}text-primary{% endif %}">
                                {{ day.day }}
                            </span>
                            {% if day == today %}
                            <span class="w-2 h-2 bg-primary rounded-full"></span>
                            {% endif %}
                        </div>

                        <!-- Task Area -->
                        <div class="p-2 space-y-1 min-h-[80px]" onclick="handleCellClick(this, '{{ day|date:'Y-m-d' }}')">
                            <!-- Team Tasks (Top Half) -->
                            <div class="space-y-1">
                                {% for task in team_tasks|slice:":2" %}
                                <div class="task-badge flex items-center gap-1.5 px-2 py-1 rounded text-xs bg-white dark:bg-slate-700 border-l-2 shadow-sm {% if task.is_completed %}opacity-50{% endif %}"
                                     style="border-left-color: {% if task.section %}{{ task.section.color_code }}{% else %}#808080{% endif %};"
                                     title="{% if task.section %}{{ task.section.name }}{% else %}General{% endif %} - {{ task.instructions|truncatechars:50 }} (Team)">
                                    {% if task.is_completed %}
                                    <span class="material-symbols-outlined text-[10px] text-emerald-500">check</span>
                                    {% endif %}
                                    <span class="truncate font-medium text-slate-700 dark:text-slate-200">
                                        {% if task.section %}[{{ task.section.name|truncatechars:8 }}]{% else %}[General]{% endif %}
                                    </span>
                                </div>
                                {% endfor %}
                            </div>

                            <!-- Manager Tasks (Bottom Half) -->
                            <div class="space-y-1">
                                {% for task in manager_tasks|slice:":2" %}
                                <div class="task-badge flex items-center gap-1.5 px-2 py-1 rounded text-xs bg-slate-50 dark:bg-slate-800 border-l-2 shadow-sm {% if task.is_completed %}opacity-50{% endif %}"
                                     style="border-left-color: {% if task.section %}{{ task.section.color_code }}{% else %}#808080{% endif %};"
                                     title="{% if task.section %}{{ task.section.name }}{% else %}General{% endif %} - {{ task.instructions|truncatechars:50 }} (Manager)">
                                    {% if task.is_completed %}
                                    <span class="material-symbols-outlined text-[10px] text-emerald-500">check</span>
                                    {% endif %}
                                    <span class="truncate font-medium text-slate-600 dark:text-slate-400">
                                        {% if task.section %}[{{ task.section.name|truncatechars:8 }}]{% else %}[Admin]{% endif %}
                                    </span>
                                </div>
                                {% endfor %}
                            </div>

                            <!-- Overflow Indicator -->
                            {% with total_tasks=team_tasks|length|add:manager_tasks|length %}
                            {% if total_tasks > 4 %}
                            <a href="{% url 'daily_agenda' %}?date={{ day|date:'Y-m-d' }}"
                               class="overflow-indicator block text-center py-1 text-xs font-medium text-primary hover:text-forest transition-colors"
                               onclick="event.stopPropagation();">
                                +{{ total_tasks|add:"-4" }} more
                            </a>
                            {% endif %}
                            {% endwith %}
                        </div>

                        <!-- Hover Add Button -->
                        <button class="absolute bottom-2 right-2 p-1.5 bg-white dark:bg-slate-700 text-slate-400 dark:text-slate-500 border border-slate-200 dark:border-slate-600 rounded shadow-sm transition-all hover:text-primary hover:border-primary/50 hover:scale-110 active:scale-95 opacity-0 group-hover:opacity-100 add-task-btn"
                                data-date="{{ day|date:'Y-m-d' }}"
                                onclick="event.stopPropagation();">
                            <span class="material-symbols-outlined text-sm font-bold">add</span>
                        </button>
                    </div>
                    {% endwith %}
                    {% endwith %}
                    {% endwith %}
                {% endfor %}
            </div>
            {% endfor %}
        </div>

        <!-- Legend -->
        <div class="mt-8 flex items-center gap-6 text-sm text-slate-500">
            <div class="flex items-center gap-2">
                <div class="w-3 h-3 rounded bg-slate-100 dark:bg-slate-800 border border-slate-200"></div>
                <span>Team Task</span>
            </div>
            <div class="flex items-center gap-2">
                <div class="w-3 h-3 rounded bg-slate-50 dark:bg-slate-900 border border-slate-200"></div>
                <span>Manager Task</span>
            </div>
            <div class="flex items-center gap-2">
                <span class="material-symbols-outlined text-sm text-emerald-500">check</span>
                <span>Completed</span>
            </div>
            <div class="flex items-center gap-2">
                <span class="w-2 h-2 bg-primary rounded-full"></span>
                <span>Today</span>
            </div>
        </div>
    </div>
</div>

<!-- Task Creation Modal -->
<div id="addTaskModal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-slate-900/50 backdrop-blur-sm"></div>
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="w-full max-w-xl bg-white dark:bg-slate-900 rounded-xl shadow-2xl overflow-hidden border border-slate-200 dark:border-slate-800 animate-in fade-in zoom-in duration-300 relative">
            <div class="px-6 py-4 border-b border-slate-100 dark:border-slate-800 flex justify-between items-center">
                <div>
                    <h2 class="text-xl font-semibold text-slate-800 dark:text-slate-100" id="modalTitle">Create New Task</h2>
                    <p class="text-sm text-slate-500 dark:text-slate-400">Plan and assign a task for the Liesbeek project.</p>
                </div>
                <button class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200 transition-colors close-modal-btn">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>

            <form method="post" action="{% url 'task_create' %}" class="p-6 space-y-5">
                {% csrf_token %}
                <input type="hidden" name="date" id="modalDate">
                <input type="hidden" name="assignee_type" id="modalAssignee">
                <input type="hidden" name="next" value="{{ request.get_full_path }}">

                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-1.5">
                        <label class="text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400">Task Date</label>
                        <div class="relative">
                            <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-sm">calendar_today</span>
                            <input type="date" name="date_proxy" id="modalDateDisplay" required class="w-full pl-10 pr-4 py-2 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-lg focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all text-slate-800 dark:text-slate-200 outline-none">
                        </div>
                    </div>
                    <div class="space-y-1.5">
                        <label class="text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400">Assignee Type</label>
                        <div class="relative">
                            <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-sm">groups</span>
                            <select name="assignee_type_proxy" id="modalAssigneeDisplay" class="w-full pl-10 pr-4 py-2 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-lg appearance-none focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all text-slate-800 dark:text-slate-200 outline-none">
                                <option value="team">Team</option>
                                <option value="manager">Manager</option>
                            </select>
                            <span class="material-symbols-outlined absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none">expand_more</span>
                        </div>
                    </div>
                </div>

                <div class="space-y-1.5">
                    <label class="text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400">River Section</label>
                    <div class="relative">
                        <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-sm">map</span>
                        <select name="section" id="sectionSelect" class="w-full pl-10 pr-10 py-2 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-lg appearance-none focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all text-slate-800 dark:text-slate-200 outline-none">
                            <option value="">No Section</option>
                            {% for section in sections %}
                            <option value="{{ section.id }}" data-color="{{ section.color_code }}">
                                {{ section.name }}
                            </option>
                            {% endfor %}
                        </select>
                        <span class="material-symbols-outlined absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none">expand_more</span>
                    </div>
                </div>

                <div class="space-y-1.5">
                    <label class="text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400">Task Template</label>
                    <div class="relative">
                        <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-sm">assignment</span>
                        <select name="template" id="templateSelect" class="w-full pl-10 pr-10 py-2 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-lg appearance-none focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all text-slate-800 dark:text-slate-200 outline-none">
                            <option value="">No template</option>
                        </select>
                        <span class="material-symbols-outlined absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none">expand_more</span>
                    </div>
                </div>

                <!-- Hidden data stores for templates -->
                <script id="teamTemplatesData" type="application/json">
                [
                    {% for template in team_task_templates %}
                    {"id": {{ template.id }}, "name": "{{ template.name|escapejs }}", "task_type": "{{ template.get_task_type_display|escapejs }}", "instructions": "{{ template.default_instructions|escapejs }}"}{% if not forloop.last %},{% endif %}
                    {% endfor %}
                ]
                </script>
                <script id="managerTemplatesData" type="application/json">
                [
                    {% for template in manager_task_templates %}
                    {"id": {{ template.id }}, "name": "{{ template.name|escapejs }}", "task_type": "{{ template.get_task_type_display|escapejs }}", "instructions": "{{ template.default_instructions|escapejs }}"}{% if not forloop.last %},{% endif %}
                    {% endfor %}
                ]
                </script>

                <div class="space-y-1.5">
                    <label class="text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400">Instructions & Notes</label>
                    <div class="relative">
                        <textarea name="instructions" id="instructionsText" rows="4" class="w-full p-4 bg-slate-50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-700 rounded-lg focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all text-slate-700 dark:text-slate-300 outline-none resize-none leading-relaxed" placeholder="Add specific details for the task..."></textarea>
                        <div class="absolute bottom-3 right-3 opacity-20 dark:opacity-10 pointer-events-none">
                            <span class="material-symbols-outlined text-2xl">edit_note</span>
                        </div>
                    </div>
                </div>

                <div class="flex items-center justify-end space-x-4 pt-4 border-t border-slate-100 dark:border-slate-800">
                    <button type="button" class="px-5 py-2 text-sm font-medium text-slate-500 hover:text-slate-800 dark:text-slate-400 dark:hover:text-slate-200 transition-colors close-modal-btn">
                        Cancel
                    </button>
                    <button type="submit" class="bg-primary hover:bg-opacity-90 text-white px-6 py-2.5 rounded-lg text-sm font-semibold shadow-sm hover:shadow-md transition-all active:scale-95 flex items-center gap-2">
                        <span class="material-symbols-outlined text-lg">add_task</span>
                        Create Task
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Split filter for template
document.addEventListener('DOMContentLoaded', function() {
    // Add split filter to template
    const originalGetElementById = document.getElementById;
});

function handleCellClick(element, date) {
    const cell = element.closest('.month-cell');
    const hasTasks = cell.dataset.hasTasks === 'true';

    if (hasTasks) {
        window.location.href = '{% url "daily_agenda" %}?date=' + date;
    } else {
        // Trigger modal open
        openModal(date);
    }
}

document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('addTaskModal');
    const modalDateInput = document.getElementById('modalDate');
    const modalAssigneeInput = document.getElementById('modalAssignee');
    const modalDateDisplay = document.getElementById('modalDateDisplay');
    const modalAssigneeDisplay = document.getElementById('modalAssigneeDisplay');
    const modalTitle = document.getElementById('modalTitle');
    const templateSelect = document.getElementById('templateSelect');
    const instructionsText = document.getElementById('instructionsText');

    // Load template data
    const teamTemplates = JSON.parse(document.getElementById('teamTemplatesData').textContent);
    const managerTemplates = JSON.parse(document.getElementById('managerTemplatesData').textContent);

    // Function to update template dropdown based on assignee type
    const updateTemplateDropdown = (assigneeType) => {
        const templates = assigneeType === 'manager' ? managerTemplates : teamTemplates;
        templateSelect.innerHTML = '<option value="">No template</option>';
        templates.forEach(template => {
            const option = document.createElement('option');
            option.value = template.id;
            option.textContent = `${template.name} (${template.task_type})`;
            option.setAttribute('data-instructions', template.instructions);
            templateSelect.appendChild(option);
        });
    };

    window.openModal = function(date, assignee) {
        const d = date || new Date().toISOString().split('T')[0];
        const a = assignee || 'team';

        modalDateInput.value = d;
        modalDateDisplay.value = d;
        modalAssigneeInput.value = a;
        modalAssigneeDisplay.value = a;

        // Update template dropdown based on assignee type
        updateTemplateDropdown(a);

        modalTitle.textContent = date ? `Add Task for ${date}` : 'Create New Task';
        modal.classList.remove('hidden');
    };

    const closeModal = () => {
        modal.classList.add('hidden');
    };

    // Sync proxies back to hidden real inputs
    modalDateDisplay.addEventListener('change', (e) => {
        modalDateInput.value = e.target.value;
    });
    modalAssigneeDisplay.addEventListener('change', (e) => {
        modalAssigneeInput.value = e.target.value;
        // Update template dropdown when assignee type changes
        updateTemplateDropdown(e.target.value);
        // Clear instructions when template changes
        instructionsText.value = '';
    });

    // Open modal buttons
    document.querySelectorAll('.add-task-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.stopPropagation();
            openModal(btn.dataset.date);
        });
    });

    document.querySelector('.open-modal-btn').addEventListener('click', () => openModal());

    // Close modal buttons
    document.querySelectorAll('.close-modal-btn').forEach(btn => {
        btn.addEventListener('click', closeModal);
    });

    // Close on outside click
    modal.addEventListener('click', (e) => {
        if (e.target === modal) closeModal();
    });

    // Template selection handler
    templateSelect.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        const instructions = selectedOption.getAttribute('data-instructions');
        if (instructions) {
            instructionsText.value = instructions;
        }
    });

    // Section color preview
    const sectionSelect = document.getElementById('sectionSelect');
    sectionSelect.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        const color = selectedOption.getAttribute('data-color');
        if (color) {
            this.style.borderLeft = `4px solid ${color}`;
        } else {
            this.style.borderLeft = 'none';
        }
    });
});
</script>
{% endblock %}
