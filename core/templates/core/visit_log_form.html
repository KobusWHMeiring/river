{% extends 'base.html' %}
{% load static %}

{% block title %}Log Activity - Liesbeek Master Plan{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL,GRAD,opsz@0,0,0,24" />
<style>
    .material-symbols-outlined {
        font-variation-settings: 'FILL' 0, 'wght' 300, 'GRAD' 0, 'opsz' 24;
    }
    input[type="date"]::-webkit-calendar-picker-indicator {
        background: transparent;
        bottom: 0;
        color: transparent;
        cursor: pointer;
        height: auto;
        left: 0;
        position: absolute;
        right: 0;
        top: 0;
        width: auto;
    }
    .section-collapsed .section-content {
        display: none !important;
    }
    .section-toggle-icon {
        transform: rotate(0deg);
        transition: transform 0.2s ease;
    }
    .section-collapsed .section-toggle-icon {
        transform: rotate(-90deg);
    }
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    @keyframes slideInFromTop {
        from { transform: translateY(-0.5rem); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }
    .animate-in {
        animation: fadeIn 0.3s ease-out, slideInFromTop 0.3s ease-out;
    }
    .fade-in {
        animation: fadeIn 0.3s ease-out;
    }
    .slide-in-from-top-2 {
        --tw-translate-y: -0.5rem;
    }
</style>
{% endblock %}

{% block content %}
<header class="h-16 border-b border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-900 px-8 flex items-center justify-between shrink-0 z-10">
    <div class="flex flex-col">
        <h1 class="text-xl font-bold dark:text-white leading-tight">Log Activity</h1>
        <p class="text-xs text-slate-500 font-medium uppercase tracking-wider">Daily Maintenance Reporting</p>
    </div>
    <div class="flex items-center gap-4">
        <div class="w-8 h-8 rounded-full bg-emerald-100 dark:bg-emerald-900/40 flex items-center justify-center text-primary font-bold text-xs border border-emerald-200 dark:border-emerald-800 uppercase">
            {{ user.username|slice:":2" }}
        </div>
    </div>
</header>

<div class="flex-1 overflow-auto custom-scrollbar bg-slate-50 dark:bg-slate-950/50">
<div class="max-w-4xl mx-auto p-8 lg:p-12">
        <div class="bg-white dark:bg-slate-900 rounded-2xl border border-slate-200 dark:border-slate-800 shadow-sm overflow-hidden">
            <!-- Section Tabs (Visual Only for now) -->
            <div class="p-1 border-b border-slate-100 dark:border-slate-800 flex bg-slate-50/50 dark:bg-slate-900/50">
                <div class="flex-1 py-3 px-4 text-center border-b-2 border-primary">
                    <span class="text-xs font-bold text-primary uppercase tracking-widest">Maintenance Log</span>
                </div>
            </div>

            <form method="post" enctype="multipart/form-data" id="visitLogForm" class="p-8 lg:p-12 space-y-10">
                {% csrf_token %}
                {{ metric_formset.management_form }}
                {{ photo_formset.management_form }}
                <input type="hidden" name="next" value="{{ next }}">

                <!-- Task Context Header -->
                {% if related_task %}
                <div class="bg-slate-50 dark:bg-slate-800/50 rounded-xl border border-slate-200 dark:border-slate-700 p-6">
                    <h4 class="text-xs font-bold text-slate-500 uppercase tracking-widest flex items-center gap-2 mb-3">
                        <span class="material-symbols-outlined text-lg">assignment</span>
                        Planned Task
                    </h4>
                    <div class="flex items-start gap-4">
                        <div class="flex-1">
                            <h3 class="font-bold text-slate-800 dark:text-slate-200 text-lg">{{ related_task.template.name|default:"Unnamed Task" }}</h3>
                            <p class="text-sm text-slate-600 dark:text-slate-400 mt-1">{{ related_task.instructions|truncatewords:30 }}</p>
                            <div class="flex items-center gap-4 mt-3 text-xs text-slate-500">
                                <span class="flex items-center gap-1">
                                    <span class="material-symbols-outlined text-sm">calendar_today</span>
                                    {{ related_task.date|date:"M d, Y" }}
                                </span>
                                {% if related_task.section %}
                                <span class="flex items-center gap-1">
                                    <span class="material-symbols-outlined text-sm">location_on</span>
                                    {{ related_task.section.name }}
                                </span>
                                {% endif %}
                                {% if task_type %}
                                <span class="px-2 py-0.5 rounded-full bg-primary/10 text-primary font-medium">
                                    {{ task_type|title }}
                                </span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Core Details Section -->
                <div class="space-y-6 pt-6 border-t border-slate-100 dark:border-slate-800">
                    <h4 class="text-sm font-bold text-slate-700 dark:text-slate-300 uppercase tracking-widest flex items-center gap-2">
                        <span class="material-symbols-outlined text-lg">info</span>
                        Core Details
                    </h4>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <!-- Date -->
                        <div class="space-y-2">
                            <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 tracking-tight" for="{{ form.date.id_for_label }}">Date of Activity</label>
                            <div class="relative">
                                <span class="absolute inset-y-0 left-3 flex items-center text-slate-400 pointer-events-none">
                                    <span class="material-symbols-outlined text-lg">calendar_today</span>
                                </span>
                                <input type="date" name="{{ form.date.name }}" id="{{ form.date.id_for_label }}" value="{{ form.date.value|date:'Y-m-d'|default:'' }}" class="w-full pl-10 pr-4 py-2.5 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg text-sm focus:ring-2 focus:ring-primary/20 focus:border-primary dark:text-slate-200">
                            </div>
                            {% if form.date.errors %}<p class="text-xs text-red-500 font-medium">{{ form.date.errors.0 }}</p>{% endif %}
                        </div>

                        <!-- Section -->
                        <div class="space-y-2">
                            <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 tracking-tight" for="{{ form.section.id_for_label }}">River Section</label>
                            <div class="relative">
                                <span class="absolute inset-y-0 left-3 flex items-center text-slate-400 pointer-events-none">
                                    <span class="material-symbols-outlined text-lg">location_on</span>
                                </span>
                                <select name="{{ form.section.name }}" id="{{ form.section.id_for_label }}" class="w-full pl-10 pr-4 py-2.5 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg text-sm focus:ring-2 focus:ring-primary/20 focus:border-primary dark:text-slate-200 appearance-none">
                                    {% for choice in form.section.field.choices %}
                                        <option value="{{ choice.0 }}" {% if choice.0 == form.section.value|add:0 %}selected{% endif %}>{{ choice.1 }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            {% if form.section.errors %}<p class="text-xs text-red-500 font-medium">{{ form.section.errors.0 }}</p>{% endif %}
                        </div>

                        <!-- Task/Activity -->
                        <div class="space-y-2 md:col-span-2">
                            <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 tracking-tight" for="{{ form.task.id_for_label }}">Related Task (Optional)</label>
                            <div class="relative">
                                <span class="absolute inset-y-0 left-3 flex items-center text-slate-400 pointer-events-none">
                                    <span class="material-symbols-outlined text-lg">category</span>
                                </span>
                                <select name="{{ form.task.name }}" id="{{ form.task.id_for_label }}" class="w-full pl-10 pr-4 py-2.5 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg text-sm focus:ring-2 focus:ring-primary/20 focus:border-primary dark:text-slate-200 appearance-none">
                                    {% for choice in form.task.field.choices %}
                                        <option value="{{ choice.0 }}" {% if choice.0 == form.task.value|add:0 %}selected{% endif %}>{{ choice.1 }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Notes -->
                    <div class="space-y-2">
                        <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 tracking-tight" for="{{ form.notes.id_for_label }}">Notes & Observations</label>
                        <textarea name="{{ form.notes.name }}" id="{{ form.notes.id_for_label }}" rows="4" class="w-full px-4 py-3 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg text-sm focus:ring-2 focus:ring-primary/20 focus:border-primary dark:text-slate-200 min-h-[120px]" placeholder="Describe the work completed, any issues found, or wildlife spotted...">{{ form.notes.value|default:'' }}</textarea>
                    </div>
                </div>

                {% if task_type != 'admin' %}
                <!-- Metrics Section -->
                <div class="space-y-6 pt-6 border-t border-slate-100 dark:border-slate-800" id="metricsSection">
                    <h4 class="text-sm font-bold text-slate-700 dark:text-slate-300 uppercase tracking-widest flex items-center gap-2">
                        <span class="material-symbols-outlined text-lg">analytics</span>
                        Metrics & Collection
                    </h4>

                    <!-- Litter Section -->
                    <div class="rounded-xl border border-slate-200 dark:border-slate-700 overflow-hidden" id="litterSection" data-section="litter">
                        <div onclick="toggleSection('litter')" class="w-full px-6 py-4 bg-slate-50 dark:bg-slate-800/50 flex items-center justify-between hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors cursor-pointer" role="button">
                            <div class="flex items-center gap-3">
                                <span class="material-symbols-outlined text-slate-500">delete</span>
                                <span class="font-bold text-slate-700 dark:text-slate-300">Litter Collection</span>
                            </div>
                            <span class="material-symbols-outlined text-slate-400 section-toggle-icon" id="litterToggleIcon">expand_more</span>
                        </div>
                        <div class="section-content p-6 space-y-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                                <!-- General Litter -->
                                <div class="p-6 bg-slate-50 dark:bg-slate-800/50 rounded-xl border border-slate-200 dark:border-slate-700 text-center">
                                    <span class="material-symbols-outlined text-2xl text-slate-400 mb-2">delete</span>
                                    <h5 class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-4">General Litter Bags</h5>
                                    <div class="flex items-center justify-center gap-6">
                                        <button type="button" onclick="updateCounter('litter_general', -1)" class="w-10 h-10 rounded-full border-2 border-slate-300 dark:border-slate-600 flex items-center justify-center text-slate-500 hover:bg-white dark:hover:bg-slate-700 transition-colors">
                                            <span class="material-symbols-outlined">remove</span>
                                        </button>
                                        <span class="text-3xl font-bold dark:text-white min-w-[3rem]" id="litter_general_value">0</span>
                                        <button type="button" onclick="updateCounter('litter_general', 1)" class="w-10 h-10 rounded-full border-2 border-slate-300 dark:border-slate-600 flex items-center justify-center text-slate-500 hover:bg-white dark:hover:bg-slate-700 transition-colors">
                                            <span class="material-symbols-outlined">add</span>
                                        </button>
                                    </div>
                                    <input type="hidden" name="metrics-0-metric_type" value="litter_general">
                                    <input type="hidden" name="metrics-0-label" value="General Litter">
                                    <input type="hidden" name="metrics-0-value" id="litter_general_input" value="0">
                                </div>

                                <!-- Recyclable Litter -->
                                <div class="p-6 bg-slate-50 dark:bg-slate-800/50 rounded-xl border border-slate-200 dark:border-slate-700 text-center">
                                    <span class="material-symbols-outlined text-2xl text-emerald-500 mb-2">recycling</span>
                                    <h5 class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-4">Recyclable Bags</h5>
                                    <div class="flex items-center justify-center gap-6">
                                        <button type="button" onclick="updateCounter('litter_recyclable', -1)" class="w-10 h-10 rounded-full border-2 border-slate-300 dark:border-slate-600 flex items-center justify-center text-slate-500 hover:bg-white dark:hover:bg-slate-700 transition-colors">
                                            <span class="material-symbols-outlined">remove</span>
                                        </button>
                                        <span class="text-3xl font-bold dark:text-white min-w-[3rem]" id="litter_recyclable_value">0</span>
                                        <button type="button" onclick="updateCounter('litter_recyclable', 1)" class="w-10 h-10 rounded-full border-2 border-slate-300 dark:border-slate-600 flex items-center justify-center text-slate-500 hover:bg-white dark:hover:bg-slate-700 transition-colors">
                                            <span class="material-symbols-outlined">add</span>
                                        </button>
                                    </div>
                                    <input type="hidden" name="metrics-1-metric_type" value="litter_recyclable">
                                    <input type="hidden" name="metrics-1-label" value="Recyclable Litter">
                                    <input type="hidden" name="metrics-1-value" id="litter_recyclable_input" value="0">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Weeding Section -->
                    <div class="rounded-xl border border-slate-200 dark:border-slate-700 overflow-hidden" id="weedingSection" data-section="weeding">
                        <div onclick="toggleSection('weeding')" class="w-full px-6 py-4 bg-slate-50 dark:bg-slate-800/50 flex items-center justify-between hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors cursor-pointer" role="button">
                            <div class="flex items-center gap-3">
                                <span class="material-symbols-outlined text-slate-500">grass</span>
                                <span class="font-bold text-slate-700 dark:text-slate-300">Weeding Data</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <button type="button" onclick="event.stopPropagation(); addMetric('weed')" class="text-orange-500 text-xs font-bold flex items-center gap-1 hover:underline px-2 py-1 rounded hover:bg-orange-50">
                                    <span class="material-symbols-outlined text-sm">add</span>
                                    Add
                                </button>
                                <span class="material-symbols-outlined text-slate-400 section-toggle-icon" id="weedingToggleIcon">expand_more</span>
                            </div>
                        </div>
                        <div id="weedMetrics" class="section-content p-6 space-y-4">
                        </div>
                    </div>

                    <!-- Planting Section -->
                    <div class="rounded-xl border border-slate-200 dark:border-slate-700 overflow-hidden" id="plantingSection" data-section="planting">
                        <div onclick="toggleSection('planting')" class="w-full px-6 py-4 bg-slate-50 dark:bg-slate-800/50 flex items-center justify-between hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors cursor-pointer" role="button">
                            <div class="flex items-center gap-3">
                                <span class="material-symbols-outlined text-slate-500">forest</span>
                                <span class="font-bold text-slate-700 dark:text-slate-300">Planting Data</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <button type="button" onclick="event.stopPropagation(); addMetric('plant')" class="text-primary text-xs font-bold flex items-center gap-1 hover:underline px-2 py-1 rounded hover:bg-primary/10">
                                    <span class="material-symbols-outlined text-sm">add</span>
                                    Add
                                </button>
                                <span class="material-symbols-outlined text-slate-400 section-toggle-icon" id="plantingToggleIcon">expand_more</span>
                            </div>
                        </div>
                        <div id="plantMetrics" class="section-content p-6 space-y-4">
                            <div class="grid grid-cols-1 sm:grid-cols-12 gap-4 p-4 bg-slate-50 dark:bg-slate-800/30 rounded-xl border border-slate-200 dark:border-slate-700 items-end">
                                <div class="sm:col-span-7 space-y-1.5">
                                    <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Plant Species</label>
                                    <input type="text" name="metrics-2-label" placeholder="e.g., Kniphofia" class="w-full px-3 py-2 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg text-sm focus:ring-primary/20 dark:text-slate-200">
                                </div>
                                <div class="sm:col-span-5 flex items-center justify-between bg-white dark:bg-slate-800 px-3 py-1.5 rounded-lg border border-slate-200 dark:border-slate-700">
                                    <button type="button" onclick="updateCounter('metric_2', -1)" class="text-slate-400 hover:text-primary"><span class="material-symbols-outlined text-xl">remove</span></button>
                                    <span class="font-bold text-sm dark:text-white" id="metric_2_value">0</span>
                                    <button type="button" onclick="updateCounter('metric_2', 1)" class="text-slate-400 hover:text-primary"><span class="material-symbols-outlined text-xl">add</span></button>
                                    <input type="hidden" name="metrics-2-metric_type" value="plant">
                                    <input type="hidden" name="metrics-2-value" id="metric_2_input" value="0">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Photos Section -->
                <div class="max-w-4xl mx-auto p-8 lg:p-12 space-y-6 pt-6 border-t border-slate-100 dark:border-slate-800">
                    <h4 class="text-sm font-bold text-slate-700 dark:text-slate-300 uppercase tracking-widest flex items-center gap-2">
                        <span class="material-symbols-outlined text-lg">add_a_photo</span>
                        Visual Documentation
                    </h4>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="space-y-4">
                            <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 tracking-tight">Activity Photo</label>
                            <div id="photoUploadContainer" class="relative group">
                                <div class="border-2 border-dashed border-slate-200 dark:border-slate-700 rounded-2xl p-10 text-center bg-slate-50/50 dark:bg-slate-800/20 group-hover:border-primary/50 transition-all cursor-pointer overflow-hidden min-h-[200px] flex flex-col items-center justify-center">
                                    <img id="photoPreview" class="absolute inset-0 w-full h-full object-cover hidden" alt="Preview">
                                    <div id="uploadPlaceholder" class="flex flex-col items-center gap-2">
                                        <span class="material-symbols-outlined text-4xl text-slate-300 group-hover:text-primary transition-colors">image</span>
                                        <p class="text-sm font-medium text-slate-600 dark:text-slate-400">Capture or Upload</p>
                                        <p class="text-xs text-slate-400">Click to select file</p>
                                    </div>
                                    <input type="file" name="photos-0-file" accept="image/*" capture="environment" onchange="previewPhoto(this)" class="absolute inset-0 opacity-0 cursor-pointer">
                                </div>
                            </div>
                        </div>

                        <div class="space-y-4">
                            <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 tracking-tight" for="photoDescription">Photo Description</label>
                            <textarea name="photos-0-description" id="photoDescription" rows="6" class="w-full px-4 py-3 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg text-sm focus:ring-2 focus:ring-primary/20 focus:border-primary dark:text-slate-200 min-h-[200px]" placeholder="Describe what the photo shows (minimum 10 characters)..." ></textarea>
                            <p class="text-[10px] text-slate-400 uppercase font-bold tracking-widest italic">Required: At least 10 characters</p>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="pt-10 border-t border-slate-100 dark:border-slate-800 flex flex-col sm:flex-row items-center justify-between gap-6">
                    <div class="flex items-center gap-2 text-slate-400 hidden sm:flex">
                        <span class="material-symbols-outlined text-sm">verified_user</span>
                        <span class="text-xs font-medium">Reporting as verified field personnel.</span>
                    </div>
                    <div class="flex w-full sm:w-auto gap-4">
                        <a href="{% if next %}{{ next }}{% else %}{% url 'daily_agenda' %}{% endif %}" class="flex-1 sm:flex-none px-8 py-3 border border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-400 rounded-xl text-sm font-bold hover:bg-slate-50 dark:hover:bg-slate-800 transition-all text-center">
                            Cancel
                        </a>
                        <button type="submit" class="flex-1 sm:flex-none px-10 py-3 bg-primary text-white rounded-xl text-sm font-bold shadow-lg shadow-emerald-900/20 hover:bg-forest transition-all flex items-center justify-center gap-2">
                            <span class="material-symbols-outlined text-lg">check_circle</span>
                            Submit Log
                        </button>
                    </div>
                </div>
            </form>
        </div>
        
        <div class="mt-8 flex flex-col sm:flex-row justify-between items-center text-slate-400 text-[10px] uppercase font-bold tracking-widest gap-4">
            <p>Â© 2026 Liesbeek Management System</p>
            <div class="flex gap-6">
                <a href="#" class="hover:text-primary transition-colors">Standard Ops</a>
                <a href="#" class="hover:text-primary transition-colors">Safety</a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Task type from Django context
const taskType = '{{ task_type|default:"unplanned" }}';

// totalMetrics tracks the next available index in the formset
// Initial state: 0=litter_general, 1=litter_recyclable, 2=first_plant
let totalMetrics = 3; 

const counters = {
    litter_general: 0,
    litter_recyclable: 0,
    metric_2: 0 // First plant
};

// Section state management
const sectionStates = {
    litter: true,     // expanded by default
    weeding: true,    // expanded by default
    planting: true    // expanded by default
};

// Initialize sections based on task type
function initializeSections() {
    console.log('[DEBUG] Initializing sections for task type:', taskType);
    
    switch(taskType) {
        case 'litter_run':
            // Litter expanded, others collapsed
            sectionStates.litter = true;
            sectionStates.weeding = false;
            sectionStates.planting = false;
            break;
        case 'weeding':
            // Weeding expanded, others collapsed
            sectionStates.litter = false;
            sectionStates.weeding = true;
            sectionStates.planting = false;
            break;
        case 'planting':
            // Planting expanded, others collapsed
            sectionStates.litter = false;
            sectionStates.weeding = false;
            sectionStates.planting = true;
            break;
        case 'admin':
            // All hidden - handled by template logic
            break;
        case 'unplanned':
        default:
            // Litter expanded, weeding and planting collapsed by default
            sectionStates.litter = true;
            sectionStates.weeding = false;
            sectionStates.planting = false;
            break;
    }
    
    // Apply initial states
    Object.keys(sectionStates).forEach(section => {
        const sectionEl = document.getElementById(section + 'Section');
        console.log(`[DEBUG] Section ${section}: state=${sectionStates[section]}, hasCollapsedClass=${sectionEl ? sectionEl.classList.contains('section-collapsed') : 'N/A'}`);
        updateSectionVisibility(section);
    });
}

function toggleSection(section) {
    sectionStates[section] = !sectionStates[section];
    updateSectionVisibility(section);
}

function updateSectionVisibility(section) {
    const sectionEl = document.getElementById(section + 'Section');
    if (!sectionEl) return;
    
    const isExpanded = sectionStates[section];
    
    if (isExpanded) {
        sectionEl.classList.remove('section-collapsed');
    } else {
        sectionEl.classList.add('section-collapsed');
    }
}

function updateCounter(counterId, delta) {
    console.log(`[DEBUG] updateCounter called: counterId=${counterId}, delta=${delta}`);
    if (!counters.hasOwnProperty(counterId)) {
        counters[counterId] = 0;
        console.log(`[DEBUG] Initialized counter ${counterId} to 0`);
    }
    
    const newValue = counters[counterId] + delta;
    console.log(`[DEBUG] ${counterId}: ${counters[counterId]} + ${delta} = ${newValue}`);
    
    if (newValue >= 0) {
        counters[counterId] = newValue;
        const valElem = document.getElementById(`${counterId}_value`);
        const inputElem = document.getElementById(`${counterId}_input`);
        if (valElem) {
            valElem.textContent = newValue;
            console.log(`[DEBUG] Updated UI: ${counterId}_value = ${newValue}`);
        }
        if (inputElem) {
            inputElem.value = newValue;
            console.log(`[DEBUG] Updated input: ${counterId}_input = ${newValue}`);
        }
    }
}

function addMetric(type) {
    const containerId = type === 'plant' ? 'plantMetrics' : 'weedMetrics';
    const container = document.getElementById(containerId);
    const metricIndex = totalMetrics;
    const counterId = `metric_${metricIndex}`;
    
    const labelPlaceholder = type === 'plant' ? 'e.g., Kniphofia' : 'e.g., Wattle (Bags)';
    const labelText = type === 'plant' ? 'Plant Species' : 'Weed Species / Removal';
    const icon = type === 'plant' ? 'add_circle' : 'delete_forever';
    const accentColor = type === 'plant' ? 'primary' : 'orange-500';
    
    const newMetric = document.createElement('div');
    newMetric.className = 'grid grid-cols-1 sm:grid-cols-12 gap-4 p-4 bg-slate-50 dark:bg-slate-800/30 rounded-xl border border-slate-200 dark:border-slate-700 items-end animate-in fade-in slide-in-from-top-2 duration-300';
    newMetric.innerHTML = `
        <div class="sm:col-span-7 space-y-1.5">
            <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">${labelText}</label>
            <input type="text" name="metrics-${metricIndex}-label" placeholder="${labelPlaceholder}" class="w-full px-3 py-2 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg text-sm focus:ring-primary/20 dark:text-slate-200">
        </div>
        <div class="sm:col-span-5 flex items-center justify-between bg-white dark:bg-slate-800 px-3 py-1.5 rounded-lg border border-slate-200 dark:border-slate-700">
            <button type="button" onclick="updateCounter('${counterId}', -1)" class="text-slate-400 hover:text-primary"><span class="material-symbols-outlined text-xl">remove</span></button>
            <span class="font-bold text-sm dark:text-white" id="${counterId}_value">0</span>
            <button type="button" onclick="updateCounter('${counterId}', 1)" class="text-slate-400 hover:text-primary"><span class="material-symbols-outlined text-xl">add</span></button>
            <input type="hidden" name="metrics-${metricIndex}-metric_type" value="${type}">
            <input type="hidden" name="metrics-${metricIndex}-value" id="${counterId}_input" value="0">
        </div>
    `;
    
    container.appendChild(newMetric);
    counters[counterId] = 0;
    totalMetrics++;
    
    // Update management form total forms
    const totalFormsInput = document.getElementById('id_metrics-TOTAL_FORMS');
    if (totalFormsInput) totalFormsInput.value = totalMetrics;
}

function previewPhoto(input) {
    const preview = document.getElementById('photoPreview');
    const placeholder = document.getElementById('uploadPlaceholder');
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            preview.src = e.target.result;
            preview.classList.remove('hidden');
            if (placeholder) placeholder.classList.add('hidden');
        }
        reader.readAsDataURL(input.files[0]);
    }
}

document.addEventListener('DOMContentLoaded', function() {
    console.log('[DEBUG] Page loaded, initializing form...');
    console.log('[DEBUG] Task type:', taskType);
    
    // Set today's date if empty
    const dateField = document.querySelector('input[type="date"]');
    if (dateField && !dateField.value) {
        const today = new Date().toISOString().split('T')[0];
        dateField.value = today;
        console.log(`[DEBUG] Date set to: ${today}`);
    }
    
    // Initialize counters from existing values in DOM
    for (const counterId in counters) {
        const valElem = document.getElementById(`${counterId}_value`);
        const inputElem = document.getElementById(`${counterId}_input`);
        const existingValue = inputElem ? parseInt(inputElem.value, 10) : (valElem ? parseInt(valElem.textContent, 10) : 0);
        counters[counterId] = isNaN(existingValue) ? 0 : existingValue;
        if (valElem) valElem.textContent = counters[counterId];
    }
    console.log('[DEBUG] Counters initialized:', counters);
    
    // Set initial TOTAL_FORMS
    const totalFormsInput = document.getElementById('id_metrics-TOTAL_FORMS');
    if (totalFormsInput) {
        totalFormsInput.value = totalMetrics;
        console.log(`[DEBUG] Set metrics TOTAL_FORMS to: ${totalFormsInput.value}`);
    }
    
    // Set initial photo TOTAL_FORMS to 1
    const photoTotalForms = document.getElementById('id_photos-TOTAL_FORMS');
    if (photoTotalForms) {
        photoTotalForms.value = 1;
        console.log(`[DEBUG] Set photos TOTAL_FORMS to: ${photoTotalForms.value}`);
    }
    
    // Initialize section visibility based on task type
    initializeSections();
    
    // Add form submit listener
    const form = document.getElementById('visitLogForm');
    if (form) {
        form.addEventListener('submit', function(e) {
            console.log('[DEBUG] Form submission started');
            
            // Update all counter inputs before submit
            for (const counterId in counters) {
                const inputElem = document.getElementById(`${counterId}_input`);
                if (inputElem) {
                    inputElem.value = counters[counterId];
                }
            }
        });
    }
});
</script>
{% endblock %}