{% extends 'base.html' %}

{% block title %}{% if object %}Edit Task{% else %}Create Task{% endif %} - Liesbeek Master Plan{% endblock %}

{% block extra_css %}
<style type="text/tailwindcss">
    .material-symbols-outlined {
        font-size: 1.25rem;
    }
</style>
{% endblock %}

{% block content %}
<header class="h-16 border-b border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-900 px-8 flex items-center justify-between shrink-0 z-10">
    <div class="flex flex-col">
        <h1 class="text-xl font-bold dark:text-white leading-tight">{% if object %}Edit Task{% else %}Create New Task{% endif %}</h1>
        <p class="text-xs text-slate-500 font-medium uppercase tracking-wider">Plan and assign project activities</p>
    </div>
</header>

<div class="flex-1 overflow-auto custom-scrollbar bg-slate-50 dark:bg-slate-950/50">
    <div class="max-w-2xl mx-auto p-8 lg:p-12">
        <div class="bg-white dark:bg-slate-900 rounded-2xl border border-slate-200 dark:border-slate-800 shadow-sm overflow-hidden">
            <form method="post" class="p-8 space-y-6">
                {% csrf_token %}
                {% if request.GET.next %}
                <input type="hidden" name="next" value="{{ request.GET.next }}">
                {% endif %}
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Date -->
                    <div class="space-y-1.5">
                        <label class="text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400" for="{{ form.date.id_for_label }}">Task Date</label>
                        <div class="relative">
                            <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-sm">calendar_today</span>
                            <input type="date" name="{{ form.date.name }}" id="{{ form.date.id_for_label }}" value="{{ form.date.value|date:'Y-m-d'|default:'' }}" required class="w-full pl-10 pr-4 py-2 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-lg focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all text-slate-800 dark:text-slate-200 outline-none">
                        </div>
                        {% if form.date.errors %}<p class="text-[11px] text-red-500 font-medium">{{ form.date.errors.0 }}</p>{% endif %}
                    </div>

                    <!-- Assignee Type -->
                    <div class="space-y-1.5">
                        <label class="text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400" for="{{ form.assignee_type.id_for_label }}">Assignee Type</label>
                        <div class="relative">
                            <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-sm">groups</span>
                            <select name="{{ form.assignee_type.name }}" id="{{ form.assignee_type.id_for_label }}" class="w-full pl-10 pr-4 py-2 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-lg appearance-none focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all text-slate-800 dark:text-slate-200 outline-none">
                                {% for choice in form.assignee_type.field.choices %}
                                    <option value="{{ choice.0 }}" {% if choice.0 == form.assignee_type.value %}selected{% endif %}>{{ choice.1 }}</option>
                                {% endfor %}
                            </select>
                            <span class="material-symbols-outlined absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none">expand_more</span>
                        </div>
                        {% if form.assignee_type.errors %}<p class="text-[11px] text-red-500 font-medium">{{ form.assignee_type.errors.0 }}</p>{% endif %}
                    </div>
                </div>

                <!-- Section -->
                <div class="space-y-1.5">
                    <label class="text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400" for="{{ form.section.id_for_label }}">River Section</label>
                    <div class="relative">
                        <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-sm">map</span>
                        <select name="{{ form.section.name }}" id="{{ form.section.id_for_label }}" class="w-full pl-10 pr-10 py-2 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-lg appearance-none focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all text-slate-800 dark:text-slate-200 outline-none">
                            {% for choice in form.section.field.choices %}
                                <option value="{{ choice.0 }}" {% if choice.0 == form.section.value|add:0 %}selected{% endif %}>{{ choice.1 }}</option>
                            {% endfor %}
                        </select>
                        <span class="material-symbols-outlined absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none">expand_more</span>
                    </div>
                    {% if form.section.errors %}<p class="text-[11px] text-red-500 font-medium">{{ form.section.errors.0 }}</p>{% endif %}
                </div>

                <!-- Template -->
                <div class="space-y-1.5">
                    <label class="text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400" for="{{ form.template.id_for_label }}">Task Template</label>
                    <div class="relative">
                        <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-sm">assignment</span>
                        <select name="{{ form.template.name }}" id="{{ form.template.id_for_label }}" class="w-full pl-10 pr-10 py-2 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-lg appearance-none focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all text-slate-800 dark:text-slate-200 outline-none">
                            {% for choice in form.template.field.choices %}
                                <option value="{{ choice.0 }}" {% if choice.0 == form.template.value|add:0 %}selected{% endif %}>{{ choice.1 }}</option>
                            {% endfor %}
                        </select>
                        <span class="material-symbols-outlined absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none">expand_more</span>
                    </div>
                </div>

                <!-- Instructions -->
                <div class="space-y-1.5">
                    <label class="text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400" for="{{ form.instructions.id_for_label }}">Instructions & Notes</label>
                    <div class="relative">
                        <textarea name="{{ form.instructions.name }}" id="{{ form.instructions.id_for_label }}" rows="6" class="w-full p-4 bg-slate-50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-700 rounded-lg focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all text-slate-700 dark:text-slate-300 outline-none resize-none leading-relaxed" placeholder="Add specific details for the task...">{{ form.instructions.value|default:'' }}</textarea>
                        <div class="absolute bottom-3 right-3 opacity-20 dark:opacity-10 pointer-events-none">
                            <span class="material-symbols-outlined text-2xl">edit_note</span>
                        </div>
                    </div>
                    {% if form.instructions.errors %}<p class="text-[11px] text-red-500 font-medium">{{ form.instructions.errors.0 }}</p>{% endif %}
                </div>

                <div class="flex items-center justify-end space-x-4 pt-6 border-t border-slate-100 dark:border-slate-800">
                    <a href="{% if request.GET.next %}{{ request.GET.next }}{% else %}{% url 'weekly_planner' %}{% endif %}" class="px-6 py-2.5 text-sm font-semibold text-slate-500 hover:text-slate-800 dark:text-slate-400 dark:hover:text-slate-200 transition-colors">
                        Cancel
                    </a>
                    <button type="submit" class="bg-primary hover:bg-opacity-90 text-white px-8 py-2.5 rounded-lg text-sm font-bold shadow-sm hover:shadow-md transition-all active:scale-95 flex items-center gap-2">
                        <span class="material-symbols-outlined text-lg">{% if object %}save{% else %}add_task{% endif %}</span>
                        {% if object %}Update{% else %}Create{% endif %} Task
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const templateSelect = document.getElementById('{{ form.template.id_for_label }}');
    const instructionsText = document.getElementById('{{ form.instructions.id_for_label }}');
    
    // We'll need the templates data for JS-side population
    const templates = {
        {% for template in task_templates %}
        "{{ template.id }}": "{{ template.default_instructions|escapejs }}",
        {% endfor %}
    };
    
    if (templateSelect && instructionsText) {
        templateSelect.addEventListener('change', function() {
            const selectedId = this.value;
            if (templates[selectedId]) {
                instructionsText.value = templates[selectedId];
            }
        });
    }
});
</script>
{% endblock %}