{% extends 'base.html' %}

{% block title %}{% if object %}Edit Section{% else %}Create Section{% endif %} - Liesbeek Master Plan{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>
<style type="text/tailwindcss">
    .material-symbols-outlined {
        font-size: 1.25rem;
    }
    #map {
        height: 400px;
        width: 100%;
        border-radius: 0.5rem;
        border: 1px solid #e2e8f0;
    }
    .leaflet-control-draw {
        border-radius: 4px;
        box-shadow: 0 1px 5px rgba(0,0,0,0.65);
    }
</style>
{% endblock %}

{% block content %}
<header class="h-16 border-b border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-900 px-8 flex items-center justify-between shrink-0 z-10">
    <div class="flex flex-col">
        <h1 class="text-xl font-bold dark:text-white leading-tight">{% if object %}Edit River Section{% else %}Create New River Section{% endif %}</h1>
        <p class="text-xs text-slate-500 font-medium uppercase tracking-wider">Define section properties and spatial boundaries</p>
    </div>
</header>

<div class="flex-1 overflow-auto custom-scrollbar bg-slate-50 dark:bg-slate-950/50">
    <div class="max-w-4xl mx-auto p-8 lg:p-12">
        <form method="post" class="space-y-6">
            {% csrf_token %}
            
            <!-- Hidden fields for map data -->
            {{ form.boundary_data }}
            {{ form.center_point }}
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Left Column: Basic Info -->
                <div class="bg-white dark:bg-slate-900 rounded-2xl border border-slate-200 dark:border-slate-800 shadow-sm overflow-hidden p-8 space-y-6">
                    <h3 class="text-sm font-bold text-primary uppercase tracking-wider mb-4">Section Information</h3>
                    
                    <!-- Section Name -->
                    <div class="space-y-1.5">
                        <label class="text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400" for="{{ form.name.id_for_label }}">Section Name</label>
                        <div class="relative">
                            <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-sm">location_on</span>
                            <input type="text" name="{{ form.name.name }}" id="{{ form.name.id_for_label }}" value="{{ form.name.value|default:'' }}" required maxlength="100" class="w-full pl-10 pr-4 py-2 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-lg focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all text-slate-800 dark:text-slate-200 outline-none" placeholder="e.g., Black River Confluence">
                        </div>
                        {% if form.name.errors %}<p class="text-[11px] text-red-500 font-medium">{{ form.name.errors.0 }}</p>{% endif %}
                    </div>

                    <!-- Color Code -->
                    <div class="space-y-1.5">
                        <label class="text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400" for="{{ form.color_code.id_for_label }}">Color Code</label>
                        <div class="flex items-center gap-4">
                            <div class="relative flex-1">
                                <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-sm">palette</span>
                                <input type="color" name="{{ form.color_code.name }}" id="{{ form.color_code.id_for_label }}" value="{{ form.color_code.value|default:'#808080' }}" class="w-full h-10 pl-10 pr-4 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-lg cursor-pointer">
                            </div>
                            <div class="w-12 h-12 rounded-lg border border-slate-200 dark:border-slate-700" style="background-color: {{ form.color_code.value|default:'#808080' }};" id="colorPreview"></div>
                        </div>
                        {% if form.color_code.errors %}<p class="text-[11px] text-red-500 font-medium">{{ form.color_code.errors.0 }}</p>{% endif %}
                    </div>

                    <!-- Current Stage -->
                    <div class="space-y-1.5">
                        <label class="text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400" for="{{ form.current_stage.id_for_label }}">Lifecycle Stage</label>
                        <div class="relative">
                            <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-sm">timeline</span>
                            <select name="{{ form.current_stage.name }}" id="{{ form.current_stage.id_for_label }}" class="w-full pl-10 pr-4 py-2 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-lg appearance-none focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all text-slate-800 dark:text-slate-200 outline-none">
                                {% for choice in form.current_stage.field.choices %}
                                    <option value="{{ choice.0 }}" {% if choice.0 == form.current_stage.value %}selected{% endif %}>{{ choice.1 }}</option>
                                {% endfor %}
                            </select>
                            <span class="material-symbols-outlined absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none">expand_more</span>
                        </div>
                        {% if form.current_stage.errors %}<p class="text-[11px] text-red-500 font-medium">{{ form.current_stage.errors.0 }}</p>{% endif %}
                    </div>

                    <!-- Position -->
                    <div class="space-y-1.5">
                        <label class="text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400" for="{{ form.position.id_for_label }}">Position (Order)</label>
                        <div class="relative">
                            <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-sm">sort</span>
                            <input type="number" name="{{ form.position.name }}" id="{{ form.position.id_for_label }}" value="{{ form.position.value|default:'0' }}" min="0" class="w-full pl-10 pr-4 py-2 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-lg focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all text-slate-800 dark:text-slate-200 outline-none" placeholder="0 for upstream, higher numbers downstream">
                        </div>
                        <p class="text-[11px] text-slate-400 dark:text-slate-500 mt-1">Lower numbers appear first (upstream to downstream)</p>
                        {% if form.position.errors %}<p class="text-[11px] text-red-500 font-medium">{{ form.position.errors.0 }}</p>{% endif %}
                    </div>

                    <!-- Description -->
                    <div class="space-y-1.5">
                        <label class="text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400" for="{{ form.description.id_for_label }}">Description</label>
                        <div class="relative">
                            <textarea name="{{ form.description.name }}" id="{{ form.description.id_for_label }}" rows="4" class="w-full p-4 bg-slate-50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-700 rounded-lg focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all text-slate-700 dark:text-slate-300 outline-none resize-none leading-relaxed" placeholder="Add notes about this river section...">{{ form.description.value|default:'' }}</textarea>
                            <div class="absolute bottom-3 right-3 opacity-20 dark:opacity-10 pointer-events-none">
                                <span class="material-symbols-outlined text-2xl">description</span>
                            </div>
                        </div>
                        {% if form.description.errors %}<p class="text-[11px] text-red-500 font-medium">{{ form.description.errors.0 }}</p>{% endif %}
                    </div>
                </div>

                <!-- Right Column: Map -->
                <div class="bg-white dark:bg-slate-900 rounded-2xl border border-slate-200 dark:border-slate-800 shadow-sm overflow-hidden p-8 space-y-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-sm font-bold text-primary uppercase tracking-wider">Boundary Definition</h3>
                        <span class="text-xs text-slate-400 flex items-center gap-1">
                            <span class="material-symbols-outlined text-sm">info</span>
                            Draw polygon on map
                        </span>
                    </div>
                    
                    <div class="space-y-3">
                        <p class="text-sm text-slate-500 dark:text-slate-400">
                            Use the drawing tools to define the section boundaries. Click points along the river bank to create a polygon shape.
                        </p>
                        
                        <!-- Map Container -->
                        <div id="map"></div>
                        
                        <!-- Map Controls Info -->
                        <div class="flex items-center gap-4 text-xs text-slate-400 mt-2">
                            <span class="flex items-center gap-1">
                                <span class="material-symbols-outlined text-sm">shape_line</span>
                                Draw polygon
                            </span>
                            <span class="flex items-center gap-1">
                                <span class="material-symbols-outlined text-sm">edit</span>
                                Edit shape
                            </span>
                            <span class="flex items-center gap-1">
                                <span class="material-symbols-outlined text-sm">delete</span>
                                Delete shape
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Submit Buttons -->
            <div class="flex items-center justify-end space-x-4 pt-6 border-t border-slate-200 dark:border-slate-800">
                <a href="{% url 'section_list' %}" class="px-6 py-2.5 text-sm font-semibold text-slate-500 hover:text-slate-800 dark:text-slate-400 dark:hover:text-slate-200 transition-colors">
                    Cancel
                </a>
                <button type="submit" class="bg-primary hover:bg-opacity-90 text-white px-8 py-2.5 rounded-lg text-sm font-bold shadow-sm hover:shadow-md transition-all active:scale-95 flex items-center gap-2">
                    <span class="material-symbols-outlined text-lg">{% if object %}save{% else %}add_location_alt{% endif %}</span>
                    {% if object %}Update{% else %}Create{% endif %} Section
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Color preview
    const colorInput = document.getElementById('{{ form.color_code.id_for_label }}');
    const colorPreview = document.getElementById('colorPreview');
    
    if (colorInput && colorPreview) {
        colorInput.addEventListener('input', function() {
            colorPreview.style.backgroundColor = this.value;
        });
        colorPreview.style.backgroundColor = colorInput.value;
    }

    // Map initialization - Center on Cape Town (Liesbeek River area)
    const map = L.map('map').setView([-33.935, 18.475], 13);
    
    // Add OpenStreetMap tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
        maxZoom: 19
    }).addTo(map);

    // Initialize FeatureGroup to store editable layers
    const drawnItems = new L.FeatureGroup();
    map.addLayer(drawnItems);

    // Load existing boundary data if editing
    const boundaryData = {{ form.boundary_data.value|default:"{}"|safe }};
    const centerPoint = {{ form.center_point.value|default:"{}"|safe }};
    
    if (boundaryData && boundaryData.coordinates && boundaryData.coordinates.length > 0) {
        // Restore existing polygon
        const latlngs = boundaryData.coordinates.map(coord => [coord[1], coord[0]]); // Convert [lng, lat] to [lat, lng]
        const existingPolygon = L.polygon(latlngs, {
            color: '{{ form.color_code.value|default:"#808080" }}',
            weight: 3,
            opacity: 0.8,
            fillOpacity: 0.3
        });
        drawnItems.addLayer(existingPolygon);
        map.fitBounds(existingPolygon.getBounds());
    } else if (centerPoint && centerPoint.coordinates && centerPoint.coordinates.length === 2) {
        // Center on existing center point
        map.setView([centerPoint.coordinates[1], centerPoint.coordinates[0]], 15);
    }

    // Initialize draw control
    const drawControl = new L.Control.Draw({
        draw: {
            polygon: {
                allowIntersection: false,
                showArea: true,
                drawError: {
                    color: '#e1e4e8',
                    timeout: 1000
                },
                shapeOptions: {
                    color: '{{ form.color_code.value|default:"#808080" }}',
                    weight: 3,
                    opacity: 0.8,
                    fillOpacity: 0.3
                }
            },
            polyline: false,
            rectangle: false,
            circle: false,
            circlemarker: false,
            marker: false
        },
        edit: {
            featureGroup: drawnItems,
            remove: true
        }
    });
    map.addControl(drawControl);

    // Handle created event
    map.on(L.Draw.Event.CREATED, function(event) {
        const layer = event.layer;
        
        // Clear existing layers (only allow one polygon per section)
        drawnItems.clearLayers();
        
        // Add new layer
        drawnItems.addLayer(layer);
        
        // Update hidden form fields
        updateFormFields();
    });

    // Handle edited event
    map.on(L.Draw.Event.EDITED, function(event) {
        updateFormFields();
    });

    // Handle deleted event
    map.on(L.Draw.Event.DELETED, function(event) {
        updateFormFields();
    });

    // Function to update hidden form fields with GeoJSON data
    function updateFormFields() {
        const layers = drawnItems.getLayers();
        const boundaryField = document.getElementById('{{ form.boundary_data.id_for_label }}');
        const centerField = document.getElementById('{{ form.center_point.id_for_label }}');
        
        if (layers.length > 0) {
            const layer = layers[0];
            const latlngs = layer.getLatLngs()[0]; // Get first ring of polygon
            
            // Convert to GeoJSON format [lng, lat]
            const coordinates = latlngs.map(latlng => [latlng.lng, latlng.lat]);
            
            // Update boundary_data field
            boundaryField.value = JSON.stringify({
                type: 'Polygon',
                coordinates: coordinates
            });
            
            // Calculate and update center point
            const center = layer.getCenter();
            centerField.value = JSON.stringify({
                type: 'Point',
                coordinates: [center.lng, center.lat]
            });
        } else {
            // Clear fields if no polygon
            boundaryField.value = '{}';
            centerField.value = '{}';
        }
    }

    // Update polygon color when color_code changes
    if (colorInput) {
        colorInput.addEventListener('change', function() {
            const layers = drawnItems.getLayers();
            if (layers.length > 0) {
                layers[0].setStyle({ color: this.value });
            }
            // Update draw control color
            drawControl.setDrawingOptions({
                polygon: {
                    shapeOptions: {
                        color: this.value
                    }
                }
            });
        });
    }
});
</script>
{% endblock %}
