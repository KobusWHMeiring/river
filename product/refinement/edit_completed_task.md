# PRD: Edit Log Entry from Completed Task

## 1. Problem Statement
Currently, when a user clicks "Edit" on a completed task in the daily agenda or weekly planner, it always opens the Task edit form. However, once a task is completed, the actual data of interest is the Visit Log (which contains the notes, metrics, and photos). Users expect to edit the log entry, not the original task plan.

## 2. Strategic Goal
To improve the user experience by intelligently routing the Edit action: completed tasks should open the Visit Log edit form, while incomplete tasks should continue to open the Task edit form.

## 3. Proposed Scope
- **Logic Update:** Determine if a task is completed and has an associated VisitLog
- **Routing:** Redirect to appropriate edit view based on completion status
- **Fallback:** Handle edge cases where a completed task has no VisitLog

## 4. Technical Constraints
- Must maintain existing URL patterns for Task and VisitLog editing
- Must handle the case where `task.is_completed=True` but no VisitLog exists
- VisitLog edit view may need to be created if it doesn't exist

## 5. Developer Context (Current State)

### What Already Exists
- **task_complete_view** (`core/views.py:612`): When a task is marked complete, it automatically creates a VisitLog with `task=task` FK set
- **Edit buttons in daily_agenda.html**: Lines 58 and 94 link to `task_edit` with `?next=` redirect param
- **VisitLogForm**: Already exists in `core/forms.py`

### What Needs to Be Created
- **VisitLogUpdateView**: Does NOT exist - needs to be created in `core/views.py`
- **URL pattern**: Does NOT exist - add `visit-logs/<int:pk>/edit/` to `core/urls.py`
- **Template**: Can reuse `core/templates/core/visit_log_form.html` (shares create form)

### Key Relationships
- VisitLog has `task = ForeignKey(Task)` - access via `task.visitlog_set.first()`
- Get associated VisitLog pk: `task.visitlog_set.first().pk` (if exists)

### Edit Button Locations
- `daily_agenda.html`: Lines 58, 94 (currently hardcoded to `task_edit`)
- `section_detail.html`: Lines 248, 250 (also needs updating)

### Redirect Pattern
- Currently uses `?next={{ request.get_full_path|urlencode }}` for post-edit redirect
- Should preserve this pattern for both Task and VisitLog editing

### Out of Scope (For Now)
- **weekly_planner.html**: Does NOT have edit buttons - not in scope for this PRD
- **VisitLog delete functionality**: Not covered

---

# User Stories (Generated by Technical PO)

## Story 1: Detect Completed Task with VisitLog
**Value Proposition:** As a Manager, I want the system to recognize when a task has been completed with a log entry, so that I can edit the actual work done rather than the original plan.

**Technical Implementation Path:**
- Target File: `core/templates/core/daily_agenda.html`
  - Modify the Edit button link to check `task.is_completed` and `task.visitlog_set.exists()`
  - Conditionally render either `{% url 'task_edit' task.pk %}` or the VisitLog edit URL
- Target File: `core/views.py`
  - Verify `VisitLogCreateView` saves the relationship to the Task

**Acceptance Criteria (AC):**
- [ ] Completed task with VisitLog shows "Edit Log" button
- [ ] Incomplete task shows "Edit Task" button
- [ ] Button text reflects what will be edited

**The Test Plan (MANDATORY):**
- **Integration Test:** Complete a task (creates VisitLog), verify Edit button navigates to VisitLog edit. Uncomplete the task, verify Edit navigates to Task edit.

---

## Story 2: VisitLog Edit View
**Value Proposition:** As a Manager, I want to be able to edit the VisitLog details after a task is completed, so that I can correct any mistakes in the logged data.

**Technical Implementation Path:**
- Target File: `core/views.py`
  - Create `VisitLogUpdateView` (UpdateView) if not exists
  - Use existing `VisitLogForm`
- Target File: `core/urls.py`
  - Add URL pattern for `visit-logs/<int:pk>/edit/`
- Target File: `core/templates/core/visit_log_form.html`
  - May reuse the create form with pre-populated data

**Acceptance Criteria (AC):**
- [ ] VisitLog edit view loads with existing data
- [ ] Saving updates the VisitLog and its metrics
- [ ] User is redirected back to the daily agenda after save

**The Test Plan (MANDATORY):**
- **Integration Test:** Edit a VisitLog, verify changes persist.

---

## Story 3: Fallback for Orphan Completed Tasks
**Value Proposition:** As a System, I want to handle edge cases gracefully when a task is marked complete but no VisitLog exists.

**Technical Implementation Path:**
- Target File: `core/templates/core/daily_agenda.html`
  - If `task.is_completed=True` but no VisitLog exists, fall back to Task edit
- Target File: `core/views.py`
  - Ensure the logic checks for VisitLog existence before routing

**Acceptance Criteria (AC):**
- [ ] Orphan completed tasks (no VisitLog) still allow editing via Task edit
- [ ] No broken links or 404 errors

**The Test Plan (MANDATORY):**
- **Edge Case Test:** Manually mark a task as completed without creating a VisitLog. Verify Edit button works.

---

**CRITICAL STOP RULE:**
Should the "Edit" button be renamed to "Edit Log" when it will open the VisitLog, to provide clearer affordance?

**Decision:** Yes - conditionally show "Edit Task" vs "Edit Log" based on completion status.
