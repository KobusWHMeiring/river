# PRD: Sections with Recent Activity on Dashboard

## 1. Problem Statement
The current dashboard shows a feed of recent activities (VisitLogs) but doesn't clearly highlight which sections are actively being worked on. Users must scan through the activity feed to understand section engagement. A dedicated "Active Sections" view would provide instant clarity on which sections are receiving attention.

## 2. Strategic Goal
To complement the activity feed with a section-focused view that shows which river sections have recent activity, their current status, and when they were last visited.

## 3. Proposed Scope
- **Active Sections List:** Show sections that have had a VisitLog within a defined timeframe (e.g., last 30 days)
- **Visual Indicators:** Display section color, name, last activity date, and a brief activity summary
- **Dashboard Integration:** Add as a new card/section alongside existing dashboard components

## 4. Technical Constraints
- Must be performant (avoid N+1 queries)
- Should use existing Section and VisitLog models
- Must integrate with existing dashboard layout

## 5. Developer Context (Current State)

### Dashboard Current Layout
- **Grid System**: 12-column grid with two main areas:
  - Left column (`col-span-12 lg:col-span-4`): Lifecycle Progress card
  - Right column (`col-span-12 lg:col-span-8`): Recent Activity Feed
- **Impact Counters**: 3 cards (Litter, Re-Planting, Invasives) - could add Active Sections as 4th or new row
- **Location for new card**: Options:
  - Add as 4th impact counter card (replace removed Success Metrics position)
  - Add below Lifecycle Progress in left column
  - Add as new row below impact counters

### Existing Query Patterns (in GlobalDashboardView)
```python
# Already in get_queryset():
VisitLog.objects.all().prefetch_related('metrics', 'photos', 'section').order_by('-date', '-created_at')[:15]

# Stage distribution pattern (for reference):
Section.objects.values('current_stage').annotate(count=Count('id'))
```

### Query Strategy for Active Sections
```python
from django.utils import timezone
from datetime import timedelta

# Get sections with recent activity (last 30 days)
thirty_days_ago = timezone.now().date() - timedelta(days=30)
active_sections = Section.objects.filter(
    visitlog__date__gte=thirty_days_ago
).annotate(
    last_visit_date=Max('visitlog__date'),
    visit_count=Count('visitlog')
).distinct().order_by('-last_visit_date')

# Inactive sections (no visits in last 30 days OR no visits at all)
inactive_sections = Section.objects.exclude(
    id__in=active_sections.values('id')
)
```

### Models & Fields
- **Section**: `name`, `color_code`, `current_stage`, `position`, `description`
- **VisitLog**: `section` (FK), `date`, `notes`, `created_at`, `task` (FK)
- **Key**: Use `visitlog__date` for querying (reverse FK relationship)

### Template Styling Reference
- Existing card style: `bg-white dark:bg-slate-900 rounded-2xl border border-slate-200 dark:border-slate-800 p-6 shadow-sm`
- Section color badge: Use section's `color_code` field with border styling
- Date display: Use Django's `|timesince` filter (e.g., "2 days ago")

### Related Context Variables Already Available
- `stage_distribution` (list of dicts with code, label, count, percentage)
- `recent_visits` (VisitLog queryset, 15 items)
- Can reuse patterns from Stage Distribution card

### Edge Cases & Considerations
- **Sections with no visits ever**: Should appear in "Needs Attention" with "No visits recorded"
- **Sections with visits older than 30 days**: Count as inactive
- **Empty database**: Handle gracefully - show "No active sections" message
- **Performance**: Use `select_related('section')` if querying VisitLogs directly
- **Timezone**: Use `timezone.now().date()` not `datetime.now().date()` for Django compatibility

### Out of Scope
- **Daily Agenda integration**: Not updating daily agenda with this feature
- **Notifications**: Not sending alerts for inactive sections
- **Historical data**: Not tracking beyond 30-day window

---

# User Stories (Generated by Technical PO)

## Story 1: Query Active Sections
**Value Proposition:** As a Manager, I want to see which sections have been worked on recently, so that I can ensure all sections receive adequate attention.

**Technical Implementation Path:**
- Target File: `core/views.py` (`GlobalDashboardView`)
  - Query sections that have VisitLogs in the last 30 days
  - Annotate with: last_visit_date, visit_count, last_activity_type
  - Order by most recent activity first
- Target File: `core/templates/core/dashboard.html`
  - Add "Active Sections" card to dashboard grid

**Acceptance Criteria (AC):**
- [ ] Dashboard shows list of sections with activity in last 30 days
- [ ] Each section shows: name, color badge, last visit date
- [ ] Sections without recent activity are excluded from this view

**The Test Plan (MANDATORY):**
- **Integration Test:** Create VisitLogs for 3 sections. Verify all 3 appear in Active Sections. Create old VisitLog (90 days ago) - verify it doesn't appear.

---

## Story 2: Section Cards with Details
**Value Proposition:** As a Manager, I want to see at a glance the status of active sections, so that I can quickly assess which areas need more attention.

**Technical Implementation Path:**
- Target File: `core/templates/core/dashboard.html`
  - Create compact section cards with:
    - Section color indicator (left border or badge)
    - Section name
    - Last activity date (e.g., "Last visited: 2 days ago")
    - Optional: visit count or brief metric summary
  - Use consistent styling with other dashboard cards

**Acceptance Criteria (AC):**
- [ ] Section cards display all required information
- [ ] Cards are visually consistent with dashboard theme
- [ ] Clicking a section navigates to its detail page

**The Test Plan (MANDATORY):**
- **Visual Test:** Load dashboard, verify Active Sections cards render correctly.

---

## Story 3: Inactive Sections Indicator
**Value Proposition:** As a Manager, I want to see which sections have NOT been visited recently, so that I can prioritize those areas.

**Technical Implementation Path:**
- Target File: `core/views.py`
  - Calculate sections WITHOUT activity in 30+ days
  - Pass as separate context variable `inactive_sections`
- Target File: `core/templates/core/dashboard.html`
  - Add "Needs Attention" section showing inactive sections
  - Use warning color (orange/red) to highlight

**Acceptance Criteria (AC):**
- [ ] Dashboard shows count of sections needing attention
- [ ] Optional: list specific sections that need visits
- [ ] Clearly distinguished from active sections

**The Test Plan (MANDATORY):**
- **Integration Test:** Create section with no visits. Verify it appears in "Needs Attention".

---

**CRITICAL STOP RULE:**
Should "Active Sections" replace the existing "Recent Activity Feed" or complement it?

**Decision:** Complement - keep the activity feed (shows WHAT happened) and add Active Sections (shows WHICH sections are engaged). This provides both temporal and spatial perspectives.

**Additional Decision:** Use 30 days as the threshold for "recent" activity. This is configurable if needed.
