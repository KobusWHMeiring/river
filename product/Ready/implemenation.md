Product Requirements Document (PRD): Liesbeek Master Plan (MVP 1)
1. Problem Statement
Friends of the Liesbeek (FoL) manages river rehabilitation through complex, color-coded Excel sheets. While effective for planning, this system makes it nearly impossible to aggregate long-term ecological data (e.g., "How many bags of litter were collected in Mowbray in 2024?" or "What is the current rehabilitation stage of San Souci?"). There is a disconnect between the Manager’s plan and the Supervisor’s daily reality.
2. Strategic Goal
To create a "System of Record" for the Liesbeek River that digitizes the weekly planning grid and captures field metrics (litter, planting, labor) at the source. This data will eventually drive annual reporting and ecological impact analysis.
3. Proposed Scope (MVP 1)
In-Scope
Section Registry: A master list of fixed river sections. Each section has a manually updated "Lifecycle Stage" (Mitigation, Clearing, Planting, Follow-up, Community).
The Weekly Planner (The Grid): A web-based calendar view with two primary rows per day: Team and Manager (Jess).
Task Templating: Pre-set task types (Litter Run, Weeding, Planting) that pre-fill common instructions.
The Daily Agenda (Supervisor View): A mobile-responsive list showing scheduled tasks for the current day.
Visit Logger:
Ability to mark scheduled tasks as "Complete."
Ability to log "Unplanned Activities" against any section.
Metrics Capture: Numerical inputs for Litter Bags (General vs. Recyclable) and Planting (Species Name + Quantity).
Photo Journal: Image upload with a mandatory description, linked to a Section and optionally a Task.
Out-of-Scope (MVP 2+)
Automated PDF Work Order generation.
Advanced map integration/GIS.
Automated "Rain Day" rescheduling logic.
Grouping sections into "Blocks."
4. User Journey
Planning (Sunday): The Manager (Jess) uses the Weekly Grid to drag/add tasks. She assigns "Mowbray Weeding" to the Team row and "Meeting with City" to her own row.
Execution (Daily): The Supervisor (Klaas) opens the Daily Agenda on a tablet. He sees "Mowbray Weeding" with Jess’s specific instructions.
Logging (End of Day): The Supervisor taps "Log Activity." He records 15 bags of litter and 10 Kniphofia plants. He snaps a photo of the cleared bank, adds a description, and hits "Submit."
Review: The Manager views the grid; the Mowbray task is now green (Complete), and the metrics are stored in the database.
5. Technical Constraints & Stack
Backend: Django (Python 3.x) with PostgreSQL.
Frontend: HTML5, CSS (Tailwind or Bootstrap), and Vanilla JavaScript. (No React/Vue to maintain simplicity and fast loading on field devices).
Mobile: The UI must be "Mobile First" specifically for the Daily Agenda and Visit Logger views.
Storage: Image uploads should be handled via Django's FileField (prepared for S3 or local storage).
6. High-Level User Stories
Manager (Jess)
As a Manager, I want to see a color-coded weekly grid so that I can visualize where the team is working at a glance.
As a Manager, I want to set a "Stage" for each section (e.g., Clearing) so that I can track long-term progress.
As a Manager, I want to distinguish between my admin tasks and the team’s field tasks so that the field team doesn't get distracted by my meetings.
Supervisor (Klaas/Team Leader)
As a Supervisor, I want to see a simple list of today's work so that I know exactly what instructions to give the team.
As a Supervisor, I want to log bags of litter and plants quickly using +/- buttons so that I don't have to type much in the field.
As a Supervisor, I want to log work that wasn't planned (e.g., an emergency cleanup) so that the team's effort is always recorded.
7. Preliminary Data Model
Section: name, color_code, current_stage, description.
Task: date, section_id (FK, optional), assignee_type (Choice: Team/Manager), instructions, is_completed (Bool).
VisitLog: task_id (FK, optional), section_id (FK), date, notes.
Metric: visit_id (FK), metric_type (Litter/Plant), label (e.g., "Kniphofia"), value (Int).
Photo: file, section_id (FK), visit_id (FK, optional), description, timestamp.

---

# User Stories (Generated by Technical PO)

## Story 1: Section Registry - Create and Manage River Sections
**Value Proposition:** As a Manager, I want to create and manage a master list of fixed river sections with lifecycle stages, so that I can track long-term progress of river rehabilitation.

**Technical Implementation Path:**
- Target File: `core/models.py` (create `Section` model with fields: name, color_code, current_stage, description)
- Target File: `core/admin.py` (register `Section` model with admin configuration)
- Target File: `core/views.py` (create `SectionListView` and `SectionDetailView`)
- Target File: `core/templates/core/section_list.html` (display grid of sections with color coding)
- Target File: `core/forms.py` (create `SectionForm` for CRUD operations)
- Target File: `core/urls.py` (add routes: `/sections/`, `/sections/<id>/`)

**Acceptance Criteria (AC):**
- [ ] Manager can create a new section with name, color code, lifecycle stage, and description
- [ ] Manager can view all sections in a list view with color-coded indicators
- [ ] Manager can edit section details including changing the lifecycle stage
- [ ] Manager can delete sections (with soft-delete consideration for data integrity)
- [ ] Each section displays its current stage clearly (Mitigation, Clearing, Planting, Follow-up, Community)

**The Test Plan (MANDATORY):**
- **Unit Test:** Test `Section` model creation, update, and validation. Verify `color_code` accepts hex values. Verify `current_stage` choices validation.
- **Integration Test:** Navigate to `/sections/` via browser, verify all sections render with correct colors. Click a section to view/edit details. Test stage dropdown saves correctly.
- **Edge Case:** What happens if a section name is duplicated? Test unique constraint. What if a section has existing tasks - should deletion be blocked or cascade?

---

## Story 2: The Weekly Planner - Grid View for Task Scheduling
**Value Proposition:** As a Manager, I want to see and manage a color-coded weekly grid, so that I can visualize team assignments and my own administrative tasks at a glance.

**Technical Implementation Path:**
- Target File: `core/models.py` (create `Task` model with: date, section_id [FK], assignee_type [Choice: Team/Manager], instructions, is_completed)
- Target File: `core/views.py` (create `WeeklyPlannerView` with date range filtering)
- Target File: `core/templates/core/weekly_planner.html` (grid layout with days as columns, Team/Manager as rows)
- Target File: `static/js/weekly_planner.js` (drag-and-drop or click-to-add task functionality)
- Target File: `core/forms.py` (create `TaskForm` with date picker and section autocomplete)

**Acceptance Criteria (AC):**
- [ ] Grid displays 7 days (Sunday-Saturday) with two rows per day: "Team" and "Manager"
- [ ] Tasks appear in the appropriate cell based on date and assignee_type
- [ ] Tasks are color-coded based on section color
- [ ] Manager can add new tasks by clicking on a cell
- [ ] Manager can edit existing tasks
- [ ] Manager can delete tasks
- [ ] Completed tasks have visual distinction (e.g., strikethrough or green border)

**The Test Plan (MANDATORY):**
- **Unit Test:** Test `Task` model creation, date validation, and assignee_type choices. Test `WeeklyPlannerView` context data includes correct date range.
- **Integration Test:** Load weekly planner, verify correct number of days displayed. Click a cell, add a task, verify it appears in the correct position. Test filtering between weeks (previous/next).
- **Edge Case:** What happens if two tasks overlap on the same day for same assignee? Should this be allowed? What about tasks without a section assigned?

---

## Story 3: Task Templating - Pre-filled Task Types
**Value Proposition:** As a Manager, I want to select from preset task types (Litter Run, Weeding, Planting) that auto-fill common instructions, so that I can plan faster with consistent task descriptions.

**Technical Implementation Path:**
- Target File: `core/models.py` (create `TaskTemplate` model with: name, task_type, default_instructions)
- Target File: `core/fixtures/task_templates.json` (seed data with Litter Run, Weeding, Planting templates)
- Target File: `core/views.py` (modify task creation to accept template_id parameter)
- Target File: `static/js/weekly_planner.js` (add template selector dropdown when creating tasks)
- Target File: `core/templates/core/task_form.html` (display template selector)

**Acceptance Criteria (AC):**
- [ ] When creating a task, Manager sees a dropdown of available templates
- [ ] Selecting a template auto-populates the instructions field
- [ ] Manager can still edit the auto-populated instructions before saving
- [ ] Templates include: "Litter Run", "Weeding", "Planting" with relevant default instructions
- [ ] Manager can create a task without using a template (blank instructions)

**The Test Plan (MANDATORY):**
- **Unit Test:** Test `TaskTemplate` model. Test that applying a template correctly copies instructions to a new Task instance.
- **Integration Test:** Open task creation modal, select "Litter Run" template, verify instructions field populates. Save task, verify instructions persisted correctly.
- **Edge Case:** What if template is deleted after tasks were created using it? Should not affect existing tasks. What if Manager clears the instructions after selecting template?

---

## Story 4: The Daily Agenda - Supervisor Mobile View
**Value Proposition:** As a Supervisor, I want to see a simple mobile-responsive list of today's work on my tablet, so that I know exactly what instructions to give the team in the field.

**Technical Implementation Path:**
- Target File: `core/views.py` (create `DailyAgendaView` with today's date filter, mobile-optimized)
- Target File: `core/templates/core/daily_agenda.html` (mobile-first responsive design)
- Target File: `static/css/mobile.css` (touch-friendly buttons, large text)
- Target File: `core/urls.py` (add route: `/daily-agenda/`)

**Acceptance Criteria (AC):**
- [ ] Page loads optimized for mobile/tablet devices (minimum 320px width)
- [ ] Displays only tasks assigned to "Team" for the current date
- [ ] Each task card shows: section name, instructions, and "Log Activity" button
- [ ] Tasks are ordered by section name or priority
- [ ] Page refreshes or indicates if tasks are updated while viewing
- [ ] Large touch targets (min 44x44px) for field use with gloves

**The Test Plan (MANDATORY):**
- **Unit Test:** Test `DailyAgendaView` returns only today's tasks with assignee_type='Team'. Test view context includes only relevant fields.
- **Integration Test:** Open `/daily-agenda/` on mobile viewport (Chrome DevTools), verify layout is usable. Test touch interactions. Verify only today's tasks appear even if other dates have tasks.
- **Edge Case:** What if no tasks are scheduled for today? Display appropriate empty state message. What if multiple supervisors open the same page simultaneously?

---

## Story 5: Visit Logger - Complete Tasks and Log Unplanned Activities
**Value Proposition:** As a Supervisor, I want to mark scheduled tasks as complete and log unplanned activities, so that the team's effort is always recorded regardless of what was planned.

**Technical Implementation Path:**
- Target File: `core/models.py` (create `VisitLog` model with: task_id [FK, optional], section_id [FK], date, notes)
- Target File: `core/views.py` (create `VisitLogCreateView` and `TaskCompleteView`)
- Target File: `core/templates/core/visit_log_form.html` (form for logging visits)
- Target File: `static/js/daily_agenda.js` (handle "Complete Task" and "Log Unplanned" buttons)
- Target File: `core/forms.py` (create `VisitLogForm` with section dropdown for unplanned logs)

**Acceptance Criteria (AC):**
- [ ] Supervisor can tap "Complete Task" on a scheduled task from Daily Agenda
- [ ] Completing a task creates a VisitLog linked to the task and marks task as complete
- [ ] Supervisor can tap "Log Unplanned Activity" to create a VisitLog without a linked task
- [ ] Unplanned logs require selecting a section from dropdown
- [ ] Both types of logs include optional notes field
- [ ] Completed tasks show visual confirmation (e.g., checkmark, fade out)

**The Test Plan (MANDATORY):**
- **Unit Test:** Test `VisitLog` creation with and without linked task. Test `Task` is_completed flag updates correctly. Test validation that unplanned logs require section_id.
- **Integration Test:** From Daily Agenda, click "Complete Task" on a task, verify VisitLog created. Click "Log Unplanned", select section, add notes, submit, verify created without task link.
- **Edge Case:** What if Supervisor tries to complete same task twice? Should be prevented. What if network is intermittent during field submission?

---

## Story 6: Metrics Capture - Litter and Planting Quantities
**Value Proposition:** As a Supervisor, I want to log bags of litter and plants using +/- buttons with species names, so that I don't have to type much in the field and ecological data is captured consistently.

**Technical Implementation Path:**
- Target File: `core/models.py` (create `Metric` model with: visit_id [FK], metric_type [Choice: Litter-General, Litter-Recyclable, Plant], label [CharField], value [PositiveIntegerField])
- Target File: `core/templates/core/metrics_form.html` (counter buttons with +/- controls)
- Target File: `static/js/metrics_capture.js` (increment/decrement logic, species autocomplete for plants)
- Target File: `core/views.py` (modify VisitLog creation to include nested Metric formset)
- Target File: `core/forms.py` (create `MetricForm` and `BaseMetricFormSet`)

**Acceptance Criteria (AC):**
- [ ] Visit log form includes section for "Litter Bags (General)" with +/- buttons
- [ ] Visit log form includes section for "Litter Bags (Recyclable)" with +/- buttons
- [ ] Visit log form includes "Plants" section with species name input and quantity +/- buttons
- [ ] Multiple plant species can be added to a single visit log
- [ ] Quantities display current value clearly (large text for field visibility)
- [ ] All metrics are saved when VisitLog is submitted

**The Test Plan (MANDATORY):**
- **Unit Test:** Test `Metric` model creation with different metric_types. Test validation that value must be positive integer. Test that visit can have multiple metrics.
- **Integration Test:** Open Visit Log form, tap "+" three times on Litter-General, verify counter shows 3. Add plant species "Kniphofia" with quantity 10, submit form, verify both metrics saved to database and linked to VisitLog.
- **Edge Case:** What if quantity goes below zero? Prevent negative values. What if Supervisor enters decimal value? Should round or reject. What if 50 plant species are added - does form performance degrade?

---

## Story 7: Photo Journal - Image Upload with Descriptions
**Value Proposition:** As a Supervisor, I want to take photos of work completed with mandatory descriptions, so that there is visual evidence of rehabilitation progress linked to specific sections.

**Technical Implementation Path:**
- Target File: `core/models.py` (create `Photo` model with: file [ImageField], section_id [FK], visit_id [FK, optional], description [TextField], timestamp [DateTimeField, auto_now_add])
- Target File: `core/views.py` (create `PhotoUploadView` with form handling)
- Target File: `core/templates/core/photo_upload.html` (mobile-optimized image capture interface)
- Target File: `static/js/photo_capture.js` (access device camera, preview before upload)
- Target File: `settings.py` (configure MEDIA_ROOT and MEDIA_URL for image storage)
- Target File: `core/forms.py` (create `PhotoForm` with description validation - field is required)

**Acceptance Criteria (AC):**
- [ ] Supervisor can capture photo directly from device camera or select from gallery
- [ ] Photo upload requires a mandatory description (minimum 10 characters)
- [ ] Photo is automatically linked to the section being worked on
- [ ] Photo is optionally linked to a VisitLog if uploaded during task completion
- [ ] Photo displays timestamp automatically
- [ ] Image file size is limited to 10MB to prevent storage issues
- [ ] Supported formats: JPG, PNG

**The Test Plan (MANDATORY):**
- **Unit Test:** Test `Photo` model file upload. Test description field validation (required, min length). Test file type validation. Test file size limit enforcement.
- **Integration Test:** Open photo upload from Daily Agenda, select image, enter description, submit, verify photo saved to MEDIA_ROOT and database record created with correct section_id. Test without description - verify validation error.
- **Edge Case:** What if photo upload fails mid-way? Should handle gracefully. What if device camera is unavailable? Fallback to file picker. What if 100 photos are uploaded for one section - verify gallery view handles pagination.

---

## Story 8: Manager Dashboard - Review Completed Work
**Value Proposition:** As a Manager, I want to view completed tasks with their metrics and photos in the weekly grid, so that I can verify work was done and access ecological data for reporting.

**Technical Implementation Path:**
- Target File: `core/views.py` (enhance `WeeklyPlannerView` to include completion status and metrics)
- Target File: `core/templates/core/weekly_planner.html` (add indicators for completed tasks)
- Target File: `core/templates/core/task_detail_modal.html` (show metrics and photos when task is clicked)
- Target File: `core/views.py` (create `TaskDetailAPIView` to fetch metrics and photos for modal)
- Target File: `static/js/weekly_planner.js` (handle modal display with AJAX loading of task details)

**Acceptance Criteria (AC):**
- [ ] Completed tasks in the weekly grid show visual completion indicator (e.g., green background, checkmark)
- [ ] Clicking a completed task opens detail view showing: VisitLog notes, all Metrics, and Photos
- [ ] Manager can view aggregated metrics for the week (total litter bags, total plants by species)
- [ ] Photos display as thumbnails with click to enlarge
- [ ] Manager can export or view summary data for the week

**The Test Plan (MANDATORY):**
- **Unit Test:** Test that `WeeklyPlannerView` correctly aggregates metrics per task. Test that `TaskDetailAPIView` returns all related VisitLogs, Metrics, and Photos.
- **Integration Test:** Complete a task with metrics and photos as Supervisor. Switch to Manager view, verify task shows as complete, click to open details, verify all data displays correctly including images.
- **Edge Case:** What if task has multiple VisitLogs (completed, then reopened)? Display all. What if photo files are missing from storage but DB records exist? Handle gracefully with placeholder.

---

**CRITICAL STOP RULE:**
I have mapped these changes to Django models (`core/models.py`), views (`core/views.py`), templates (`core/templates/`), and static files (`static/js/`, `static/css/`). Does this technical path align with your vision for the architecture, or should we consider a different entry point for any of these features (e.g., using Django REST Framework for APIs, different app structure, or alternative frontend approach)?

---

# 8. PM Clarifications - Non-Functional Requirements & Constraints

## Authentication & Authorization
- **Authentication:** Django Admin only for MVP. All users (managers and supervisors) authenticate through Django Admin.
- **Authorization:** No role-based access control for MVP. All authenticated users can access all features.
- **Task Editing:** Admin editing only for now. Task editing workflow to be developed in future iterations.

## Data Volume & Performance
- **Sections:** 10-30 sections expected
- **Tasks:** Maximum 100 tasks per week
- **Photos:** Approximately 100 photos per month
- **Performance:** Page load speed is not critical - can be slow
- **Offline Support:** Online only for MVP. No offline data entry capability required.

## Data Retention & Compliance
- **Photo Retention:** All photos retained indefinitely
- **GDPR:** No GDPR requirements applicable

## Business Rules & Validation
- **Task Completion:** Binary state only - tasks can only be "done" or "not done". Partial completion and other states to be sorted later.
- **End of Day:** "End of Day" can extend to the next day. Logging can be done at any point during the day.
- **Task Status Indicator:** Tasks remain grey until logging has been completed
- **Multiple Assignments:** A section CAN be assigned to multiple tasks on the same day
- **Plant Species:** Pre-defined dropdown options available, but free text entry also allowed

## Integration Requirements
- **External Systems:** No integration with existing FoL systems required
- **Data Import:** No requirement to import existing Excel data

## Notifications & Communication
- **Notifications:** No email, SMS, or in-app notifications required

## Browser & Device Support
- **Tablet Devices:** Unknown specific models - design should be device-agnostic
- **Desktop:** Desktop browser access required for managers
- **Mobile:** Mobile-first design for Daily Agenda and Visit Logger as specified

## Backup & Disaster Recovery
- **Backups:** No backup requirements defined

## Accessibility
- **Standards:** No accessibility standard compliance requirements (WCAG, etc.)

---

## Implementation Notes

### Day Cell Navigation (Added 2026-02-16)
**Feature:** Users can click on any day cell (including day headers) in the weekly planner to navigate to that day's daily agenda.

**Technical Details:**
1. **Modified Files:**
   - `core/views.py` - Updated `DailyAgendaView` to accept a `?date=YYYY-MM-DD` query parameter
   - `core/templates/core/weekly_planner.html` - Added JavaScript click handlers and CSS cursor styling
   - `core/templates/core/daily_agenda.html` - Template already supports date display

2. **Implementation:**
   - `DailyAgendaView` now parses date parameter from GET request using `datetime.strptime(date_str, '%Y-%m-%d')`
   - If no date parameter provided, defaults to current date (backward compatible)
   - Weekly planner template includes click event listeners on `.grid-cell` and `.grid-header[data-date]` elements
   - Clicking navigates to `{% url 'daily_agenda' %}?date=${date}` where date is in YYYY-MM-DD format
   - Added `cursor: pointer` CSS for visual feedback

3. **User Experience:**
   - Clicking day headers or empty cell areas navigates to that day's agenda
   - Clicking on task items or add-task buttons does NOT trigger navigation (prevents accidental navigation)
   - Maintains backward compatibility - existing functionality unchanged

**Test Coverage:**
- Unit tests should verify `DailyAgendaView` correctly parses date parameter
- Integration tests should verify clicking day cells navigates to correct daily agenda
- Edge cases: invalid date formats should default to current date

### Daily Agenda Display Fixes (Added 2026-02-16)
**Issues Fixed:**
1. Admin/manager tasks not appearing in daily agenda
2. Task instructions not prominently displayed as headings

**Technical Details:**
1. **Modified Files:**
   - `core/views.py` - Updated `DailyAgendaView.get_queryset()` to remove `assignee_type='team'` filter
   - `core/templates/core/daily_agenda.html` - Template already uses modern Tailwind design with task headings

2. **Implementation:**
   - `DailyAgendaView` now returns all tasks for the selected date, ordered by `assignee_type` then `section__name`
   - Manager tasks appear alongside team tasks with "Manager" badge
   - Task instructions displayed as `<h3>` headings with 100-character truncation (consistent with weekly planner)
   - Empty state message updated to reflect all task types

3. **User Experience:**
   - Supervisors can now see both team and manager tasks for the day
   - Task instructions appear prominently as headings for quick scanning
   - Assignee type clearly indicated with badge (Team/Manager)
   - Visual distinction between completed and pending tasks maintained

**Test Coverage:**
- Unit tests should verify `DailyAgendaView` returns all tasks regardless of assignee_type
- Integration tests should verify manager tasks appear with correct badges
- Edge cases: days with only manager tasks should display correctly

### Section Edit Page Fix (Added 2026-02-16)
**Issue:** Section edit page was not working due to missing templates.

**Technical Details:**
1. **Missing Files Created:**
   - `core/templates/core/section_form.html` - Form for creating/editing sections
   - `core/templates/core/section_confirm_delete.html` - Delete confirmation template

2. **Implementation:**
   - `section_form.html` includes all Section fields: name, color_code (color picker), current_stage (dropdown), position, description
   - Color picker with live preview using JavaScript
   - Responsive design matching existing form patterns
   - Delete confirmation shows section details and warning about associated data

3. **User Experience:**
   - Edit button on section detail page now works
   - Create section form uses same template (shared by `SectionCreateView` and `SectionUpdateView`)
   - Color picker provides visual feedback
   - Delete flow includes confirmation with details

**Test Coverage:**
- Unit tests should verify `SectionUpdateView` and `SectionCreateView` render correctly
- Integration tests should verify form submission and validation
- Edge cases: duplicate section names should be prevented

---

**Document Status:** Ready for Dev Handoff  
**Last Updated:** 2026-02-16  
**Version:** 1.0

