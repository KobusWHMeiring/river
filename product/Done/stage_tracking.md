# PRD: Time-Stamped Section Stage Tracking

## 1. Problem Statement
Currently, a river section's `current_stage` is updated in place on the `Section` model. While we can see the current status, we have no record of when it transitioned, how long it stayed in a previous stage, or the historical progression of the rehabilitation effort.

## 2. Strategic Goal
To capture every transition of a section's "Lifecycle Stage" with a timestamp, enabling long-term visualization of progress and performance analysis (e.g., "Mowbray took 6 months to move from Clearing to Planting").

## 3. Proposed Scope
- **Data Model:** A new `SectionStageHistory` model to store transitions.
- **Automation:** Automatically record a history entry whenever `Section.current_stage` changes.
- **Visualization:** Update the `SectionDetailView` timeline to display stage transitions alongside visit logs.
- **Context:** Show "Time in Current Stage" on the section dashboard.

## 4. Technical Constraints
- Must use Django signals or override the `save()` method on the `Section` model.
- Must handle the initial creation of a section as the first stage entry.

---

# User Stories (Generated by Technical PO)

## Story 1: Stage History Data Model
**Value Proposition:** As a Manager, I want the system to automatically remember every stage change, so that I don't have to manually keep a log of historical progress.

**Technical Implementation Path:**
- Target File: `core/models.py`
  - Define `SectionStageHistory` model with: `section` (FK), `stage` (CharField), `changed_at` (DateTimeField), `notes` (TextField, optional).
- Target File: `core/admin.py`
  - Register `SectionStageHistory` as an inline or standalone list for debugging.

**Acceptance Criteria (AC):**
- [ ] System successfully stores a new record whenever a stage changes.
- [ ] Records include the section, the new stage name, and the exact date/time of change.
- [ ] Database is migratable without data loss.

**The Test Plan (MANDATORY):**
- **Unit Test:** `test_stage_history_created_on_save`: Create a Section, change its stage, save again. Verify 2 records exist in `SectionStageHistory`.
- **Edge Case:** "What if the stage is saved but hasn't actually changed?" (The logic should only trigger if the value is different).

---

## Story 2: Automated Transition Capture
**Value Proposition:** As a Manager, I want the system to "just work" when I update a section's stage in the UI, ensuring my data is always accurate without extra effort.

**Technical Implementation Path:**
- Target File: `core/models.py` (near `class Section`)
  - Override `Section.save()` or use a `pre_save` signal to compare the new `current_stage` with the value in the database.
  - If changed, create a `SectionStageHistory` entry.

**Acceptance Criteria (AC):**
- [ ] Changing a stage via the Django Admin triggers a history entry.
- [ ] Changing a stage via the `SectionUpdateView` triggers a history entry.
- [ ] Initial creation of a section creates the first history entry.

**The Test Plan (MANDATORY):**
- **Integration Test:** Update a section's stage via the web form. Verify the new stage appears in the database's history table.
- **Edge Case:** "What if multiple fields are updated but the stage remains the same?" (Verify NO history entry is created).

---

## Story 3: Visualizing Stage Changes on Section Timeline
**Value Proposition:** As a Manager, I want to see stage transitions in the section's timeline view, so that I can see work activities in the context of our long-term goals.

**Technical Implementation Path:**
- Target File: `core/views.py` (`SectionDetailView.get_context_data`)
  - Fetch `SectionStageHistory` records for the section.
  - Combine (or send separately) with `VisitLog` entries to the template.
- Target File: `core/templates/core/section_detail.html`
  - Add stylized "Stage Change" markers to the vertical timeline.
  - Use distinct icons/colors for stage transitions vs. visit logs.

**Acceptance Criteria (AC):**
- [ ] Timeline shows "Stage changed to [Stage Name]" with a date.
- [ ] The transition marker is visually distinct from a Visit Log (e.g., uses the section's color code or a unique icon).
- [ ] Items are sorted chronologically.

**The Test Plan (MANDATORY):**
- **Integration Test:** Verify that the Section Detail page renders history markers.
- **Edge Case:** "What if a section has 50 transitions?" (Ensure the layout doesn't break; consider simple list if timeline gets too long).

---

**CRITICAL STOP RULE:**
I have mapped these changes to the `Section` and a new `SectionStageHistory` model. Does this automated capture approach (overriding save/signals) align with your preference for data integrity?
