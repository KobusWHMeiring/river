# PRD: Detailed Planting Metrics on Dashboard

## 1. Problem Statement
The current dashboard shows only a total plant count under "Re-Planting" (e.g., "450 Plants"). This doesn't provide ecological insight - managers can't see what species have been planted, which species are doing well, or the diversity of the rehabilitation effort. Understanding species distribution is critical for assessing restoration success.

## 2. Strategic Goal
To transform the single "Re-Planting" metric into a rich display showing:
- Total unique species count
- Breakdown of individuals per species (top 5)
- This provides ecological context and helps identify if the planting is diverse or dominated by few species

## 3. Proposed Scope
- **Data Aggregation:** Query and group plant metrics by species (label)
- **Species Count:** Calculate total unique species planted
- **Top Species:** Identify and display the top 5 most planted species with counts
- **UI Update:** Enhance the Re-Planting card with this new information

## 4. Technical Constraints
- Must use Django ORM aggregation with `Count` and `Sum`
- Must be performant (avoid N+1 queries)
- Should handle cases with zero or sparse planting data gracefully

## 5. Developer Context (Current State)

### Current Re-Planting Card (dashboard.html:49-58)
```html
<div class="stat-card border-t-4 border-t-emerald-500">
    <span class="material-symbols-outlined">park</span>
    <span>Re-Planting</span>
    <div class="text-3xl font-bold">{{ total_plants }} <span class="text-sm">Plants</span></div>
    <p>Indigenous species added</p>
</div>
```
- Uses `total_plants` from context
- Styled with `border-t-emerald-500` (emerald color)
- 3-column grid now (removed Success Metrics card)

### Existing Query in GlobalDashboardView (views.py:51-55)
```python
# Currently used for totals
metrics = Metric.objects.all()
total_plants = metrics.filter(metric_type='plant').aggregate(total=Sum('value'))['total'] or 0
```

### Metric Model Structure (models.py:141-152)
```python
class Metric(models.Model):
    METRIC_TYPE_CHOICES = [
        ('litter_general', 'Litter (General)'),
        ('litter_recyclable', 'Litter (Recyclable)'),
        ('plant', 'Plant'),           # <-- Focus on this
        ('weed', 'Weeding / Removal'),
    ]
    visit = models.ForeignKey(VisitLog, on_delete=models.CASCADE, related_name='metrics')
    metric_type = models.CharField(max_length=20, choices=METRIC_TYPE_CHOICES)
    label = models.CharField(max_length=100, blank=True)  # <-- Species name stored here
    value = models.PositiveIntegerField(default=0)  # <-- Count stored here
```

### Query Strategy for Species Breakdown
```python
from django.db.models import Sum, Count

# Get all plant metrics with labels
plant_metrics = Metric.objects.filter(metric_type='plant')

# Total unique species
total_plant_species = plant_metrics.exclude(label='').values('label').distinct().count()

# Species breakdown with totals (grouped by label)
species_breakdown = plant_metrics.exclude(label='').values('label').annotate(
    total=Sum('value')
).order_by('-total')[:5]  # Top 5

# Handle edge case: empty label - use "Unknown" or exclude
# Note: label is CharField with blank=True, so '' (empty string) not NULL
```

### Context Variables to Add
Add to `GlobalDashboardView.get_context_data()`:
```python
context['total_plant_species'] = total_plant_species
context['plant_species_breakdown'] = list(species_breakdown)
```

### UI Layout Options
1. **Compact (in card)**: Total > species count > top 3 with counts
2. **Expanded**: Total > species count > full top 5 list
3. Keep existing emerald styling: `border-t-4 border-t-emerald-500`

### Edge Cases
- **Empty label**: Use `exclude(label='')` to filter out empty species names
- **NULL label**: Shouldn't happen (CharField, not nullable), but handle with `isnull=False`
- **Zero plants**: Show "0 Plants, 0 Species"
- **Long species names**: Use CSS `truncate` or `text-overflow: ellipsis`

---

# User Stories (Generated by Technical PO)

## Story 1: Aggregate Plant Metrics by Species
**Value Proposition:** As a Manager, I want to see how many different species have been planted across the project, so that I can assess the diversity of our rehabilitation effort.

**Technical Implementation Path:**
- Target File: `core/views.py` (`GlobalDashboardView`)
  - Query: `Metric.objects.filter(metric_type='plant')`
  - Annotate with species count: `values('label').annotate(total=Sum('value'))`
  - Calculate total unique species: `values('label').distinct().count()`
- Target Files: 
  - Context variables: `total_plant_species` (int), `plant_species_breakdown` (list of dicts)

**Acceptance Criteria (AC):**
- [ ] Dashboard displays total unique species count
- [ ] Query is optimized (single aggregation, not N+1)
- [ ] Handles zero planting data gracefully

**The Test Plan (MANDATORY):**
- **Unit Test:** Create 3 VisitLogs with plant metrics: "Restio" (10), "Bulbinella" (5), "Restio" (8). Verify unique species = 2, Restio = 18, Bulbinella = 5.

---

## Story 2: Top Species Breakdown
**Value Proposition:** As a Manager, I want to see which species are being planted most frequently, so that I can ensure we're not over-relying on a few species.

**Technical Implementation Path:**
- Target File: `core/views.py`
  - Get top 5 species by total count: `order_by('-total')[:5]`
  - Return as ordered list with species name and count
- Target File: `core/templates/core/dashboard.html`
  - Update Re-Planting card to show:
    - Total plants (existing)
    - Total species (new)
    - Top 5 list (new): "Restio: 150", "Bulbinella: 80", etc.

**Acceptance Criteria (AC):**
- [ ] Top 5 species displayed in descending order by count
- [ ] Species with 0 count excluded
- [ ] If fewer than 5 species exist, show all of them

**The Test Plan (MANDATORY):**
- **Integration Test:** Add plant metrics for 6 species. Verify top 5 shown, 6th excluded.

---

## Story 3: Enhanced Re-Planting Card UI
**Value Proposition:** As a User, I want the planting information to be visually clear and scannable, so that I can quickly understand our planting impact.

**Technical Implementation Path:**
- Target File: `core/templates/core/dashboard.html`
  - Redesign Re-Planting card:
    - Keep large total count (primary metric)
    - Add species count as secondary line: "12 Species"
    - Add compact list of top 3-5 with counts
    - Use consistent iconography (keep `park` icon)
  - Maintain existing card styling and color (emerald)

**Acceptance Criteria (AC):**
- [ ] Card is visually balanced and not cluttered
- [ ] Information hierarchy is clear (total > species count > breakdown)
- [ ] Matches existing dashboard aesthetic

**The Test Plan (MANDATORY):**
- **Visual Test:** Load dashboard, verify Re-Planting card shows all new information correctly.

---

## Story 4: Handle Edge Cases
**Value Proposition:** As a System, I want to handle edge cases gracefully so the dashboard never breaks.

**Technical Implementation Path:**
- Target File: `core/views.py`
  - Handle empty data: show "0 Plants, 0 Species"
  - Handle empty labels: group under "Unknown" or exclude
  - Handle very long species names: truncate with ellipsis in UI

**Acceptance Criteria (AC):**
- [ ] No crashes with empty database
- [ ] No crashes with NULL/missing labels
- [ ] Long names don't break layout

**The Test Plan (MANDATORY):**
- **Edge Case Test:** Create plant metric with NULL label. Verify doesn't crash.

---

**CRITICAL STOP RULE:**
Should we also track WEEDS by species in the same way (top invasive species)?

**Decision:** Yes - once planting is done, apply same pattern to weeding metrics in a future iteration. For now, focus on planting.

**Additional Decisions:**
1. Use "Species" label (not "Types" or "Varieties") for consistency
2. Show top 5 in the card, could show "View All" for full list (future enhancement)
3. Order top 5 by total count descending

### Out of Scope
- **Weeding species breakdown**: Not implementing now (see critical stop rule)
- **Species trend over time**: Not tracking historical changes
- **Section-level breakdown**: Not breaking down by section, just global
